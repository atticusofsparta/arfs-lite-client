import{parse as e}from"uuid";import t from"axios";import*as r from"crypto";import n from"futoin-hkdf";import i from"utf8";import o from"jwk-to-pem";import"bignumber.js";import"base64-js";import*as a from"mime-types";import s from"arweave";function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,"symbol"==typeof(i=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(n.key))?i:String(i),n)}var i}function c(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},d.apply(this,arguments)}function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,h(e,t)}function h(e,t){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},h(e,t)}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function v(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return f(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var p;function y(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function m(e,t,r){if(!e.s){if(r instanceof g){if(!r.s)return void(r.o=m.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(m.bind(null,e,t),m.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var g=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{m(n,1,o(this.v))}catch(e){m(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?m(n,1,t?t(i):i):r?m(n,1,r(i)):m(n,2,i)}catch(e){m(n,2,e)}},n},e}();function I(e){return e instanceof g&&1&e.s}var w=/*#__PURE__*/function(){function e(e){var r=e.gatewayUrl,n=e.maxRetriesPerRequest,i=void 0===n?8:n,o=e.initialErrorDelayMS,a=void 0===o?Pe:o,s=e.fatalErrors,u=void 0===s?be:s,c=e.validStatusCodes,d=void 0===c?[200]:c,l=e.axiosInstance,h=void 0===l?t.create({validateStatus:void 0}):l;this.gatewayUrl=void 0,this.maxRetriesPerRequest=void 0,this.initialErrorDelayMS=void 0,this.fatalErrors=void 0,this.validStatusCodes=void 0,this.axiosInstance=void 0,this.lastError="unknown error",this.lastRespStatus=0,this.gatewayUrl=r,this.maxRetriesPerRequest=i,this.initialErrorDelayMS=a,this.fatalErrors=u,this.validStatusCodes=d,this.axiosInstance=h}var r=e.prototype;return r.postChunk=function(e){try{return Promise.resolve(this.postToEndpoint("chunk",e)).then(function(){})}catch(e){return Promise.reject(e)}},r.postTxHeader=function(e){try{return Promise.resolve(this.postToEndpoint("tx",e)).then(function(){})}catch(e){return Promise.reject(e)}},r.gqlRequest=function(e){try{var t=this;return Promise.resolve(y(function(){return Promise.resolve(t.postToEndpoint("graphql",e)).then(function(e){return e.data.data.transactions})},function(e){throw Error("GQL Error: "+e.message)}))}catch(e){return Promise.reject(e)}},r.postToEndpoint=function(e,t){try{var r=this;return Promise.resolve(r.retryRequestUntilMaxRetries(function(){return r.axiosInstance.post(""+r.gatewayUrl.href+e,t)}))}catch(e){return Promise.reject(e)}},r.getTransaction=function(e){try{var t=this;return Promise.resolve(y(function(){return Promise.resolve(t.retryRequestUntilMaxRetries(function(){return t.axiosInstance.get(t.gatewayUrl.href+"tx/"+e)})).then(function(e){return e.data})},function(){throw Error("Transaction could not be found from the gateway: (Status: "+t.lastRespStatus+") "+t.lastError)}))}catch(e){return Promise.reject(e)}},r.getTxData=function(e){try{var t=this;return Promise.resolve(te.get(e)).then(function(r){return r||Promise.resolve(t.retryRequestUntilMaxRetries(function(){return t.axiosInstance.get(""+t.gatewayUrl.href+e,{responseType:"arraybuffer"})})).then(function(t){var r=t.data;return Promise.resolve(te.put(e,r)).then(function(){return r})})})}catch(e){return Promise.reject(e)}},r.retryRequestUntilMaxRetries=function(e){try{var t,r=function(e){if(t)return e;throw new Error("Request to gateway has failed: (Status: "+n.lastRespStatus+") "+n.lastError)},n=this,i=0,o=function(e,t,r){for(var n;;){var i=e();if(I(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!I(o)){n=1;break}o=o.s}if(t){var a=t();if(a&&a.then&&!I(a)){n=2;break}}}var s=new g,u=m.bind(null,s,2);return(0===n?i.then(d):1===n?o.then(c):a.then(l)).then(void 0,u),s;function c(n){o=n;do{if(t&&(a=t())&&a.then&&!I(a))return void a.then(l).then(void 0,u);if(!(i=e())||I(i)&&!i.v)return void m(s,1,o);if(i.then)return void i.then(d).then(void 0,u);I(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function d(e){e?(o=r())&&o.then?o.then(c).then(void 0,u):c(o):m(s,1,o)}function l(){(i=e())?i.then?i.then(d).then(void 0,u):d(i):m(s,1,o)}}(function(){return!t&&i<=n.maxRetriesPerRequest},void 0,function(){return Promise.resolve(n.tryRequest(e)).then(function(e){function r(){function e(){i=t}console.error("Request to gateway has failed: (Status: "+n.lastRespStatus+") "+n.lastError);var t=i+1,r=function(){if(t<=n.maxRetriesPerRequest)return Promise.resolve(n.exponentialBackOffAfterFailedRequest(i)).then(function(){console.error("Retrying request, retry attempt "+t+"...")})}();return r&&r.then?r.then(e):e()}if(e)return i>0&&console.error("Request has been successfully retried!"),t=1,e;n.throwIfFatalError();var o=function(){if(429===n.lastRespStatus)return Promise.resolve(n.rateLimitThrottle()).then(function(){})}();return o&&o.then?o.then(r):r()})});return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(e){return Promise.reject(e)}},r.tryRequest=function(e){try{var t,r=this,n=y(function(){return Promise.resolve(e()).then(function(e){var n;if(r.lastRespStatus=e.status,r.isRequestSuccessful())return t=1,e;r.lastError=null!=(n=e.statusText)?n:e})},function(e){r.lastError=e instanceof Error?e.message:e});return Promise.resolve(n&&n.then?n.then(function(e){return t?e:void 0}):t?n:void 0)}catch(e){return Promise.reject(e)}},r.isRequestSuccessful=function(){return this.validStatusCodes.includes(this.lastRespStatus)},r.throwIfFatalError=function(){if(this.fatalErrors.includes(this.lastError))throw new Error("Fatal error encountered: (Status: "+this.lastRespStatus+") "+this.lastError)},r.exponentialBackOffAfterFailedRequest=function(e){try{var t=Math.pow(2,e)*this.initialErrorDelayMS;return console.error("Waiting for "+(t/1e3).toFixed(1)+" seconds before next request..."),Promise.resolve(new Promise(function(e){return setTimeout(e,t)})).then(function(){})}catch(e){return Promise.reject(e)}},r.rateLimitThrottle=function(){try{return console.error("Gateway has returned a "+this.lastRespStatus+" status which means your IP is being rate limited. Pausing for "+60..toFixed(1)+" seconds before trying next request..."),Promise.resolve(new Promise(function(e){return setTimeout(e,6e4)})).then(function(){})}catch(e){return Promise.reject(e)}},e}();p=Symbol.toPrimitive;var P,b=/*#__PURE__*/function(){function e(e){if(this.byteCount=void 0,this.byteCount=e,!Number.isFinite(this.byteCount)||!Number.isInteger(this.byteCount)||this.byteCount<0)throw new Error("Byte count must be a non-negative integer value!")}var t=e.prototype;return t[p]=function(e){return"string"===e&&this.toString(),this.byteCount},t.plus=function(t){return new e(this.byteCount+t.byteCount)},t.minus=function(t){return new e(this.byteCount-t.byteCount)},t.isGreaterThan=function(e){return this.byteCount>e.byteCount},t.isGreaterThanOrEqualTo=function(e){return this.byteCount>=e.byteCount},t.toString=function(){return""+this.byteCount},t.valueOf=function(){return this.byteCount},t.toJSON=function(){return this.byteCount},t.equals=function(e){return this.byteCount===e.byteCount},e}(),T=function(e){return"\n\tedges {\n\t\t"+(e?"":"cursor")+"\n\t\t\n\tnode {\n\t\tid\n\t\ttags {\n\t\t\tname\n\t\t\tvalue\n\t\t}\n\t\t\n\towner {\n\t\taddress\n\t}\n\n\t}\n\n\t}\n"},F=Te?Object.values(Te):[];function D(e){for(var t="",r=e.length,n=0;n<r;n++)t+=String.fromCharCode(e[n]);return t}function S(e){for(var t=atob(e),r=t.length,n=new Uint8Array(r),i=0;i<r;i++)n[i]=t.charCodeAt(i);return n}function x(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}const E="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function A(e,t,r){if(!e.s){if(r instanceof C){if(!r.s)return void(r.o=A.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(A.bind(null,e,t),A.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var C=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{A(n,1,o(this.v))}catch(e){A(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?A(n,1,t?t(i):i):r?A(n,1,r(i)):A(n,2,i)}catch(e){A(n,2,e)}},n},e}();function N(e){return e instanceof C&&1&e.s}P=Symbol.toPrimitive;var j=/*#__PURE__*/function(){function e(e){if(this.address=void 0,this.address=e,!new RegExp("^[a-zA-Z0-9_-]{43}$").test(e))throw new Error("Arweave addresses must be 43 characters in length with characters in the following set: [a-zA-Z0-9_-]")}var t=e.prototype;return t[P]=function(e){if("number"===e)throw new Error("Arweave addresses cannot be interpreted as a number!");return this.toString()},t.equals=function(e){return this.address===e.address},t.toString=function(){return this.address},t.valueOf=function(){return this.address},t.toJSON=function(){return this.toString()},e}();function M(e){return new j(e)}var O,q,R=/*#__PURE__*/function(){function t(e){var t=e.password,r=e.driveKeys,n=e.wallet;if(this.password=void 0,this.wallet=void 0,this.driveKeyCache={},this.unverifiedDriveKeys=void 0,t&&!n)throw new Error("Password supplied without a wallet. Did you forget to include your wallet?");if(t&&r)throw new Error("Password and drive keys can't be used together. Please provide one or the other.");this.unverifiedDriveKeys=null!=r?r:[],this.password=t,this.wallet=n}var a=t.prototype;return a.safelyDecryptToJson=function(t,a,s,u){try{var c,d=function(d){var h;if(c)return d;var f=function(){if(l.password&&l.wallet)return Promise.resolve(function(t,a,s){try{var u=new Uint8Array(e(a)),c=function(){for(var e,t=[].slice.call(arguments),r=t.reduce(function(e,t){return e+t.length},0),n=new Uint8Array(r),i=0,o=v(t);!(e=o()).done;){var a=e.value;n.set(a,i),i+=a.length}return n}(new Uint8Array(X(i.encode("drive"))),u);return Promise.resolve(function(e,t){try{var n=r.createSign("sha256");n.update(t);var i=o(e,{private:!0}),a=n.sign({key:i,padding:r.constants.RSA_PKCS1_PSS_PADDING,saltLength:0});return Promise.resolve(a)}catch(e){return Promise.reject(e)}}(JSON.parse(s),c)).then(function(e){var r=D(new Uint8Array(X(i.encode(t))));return Promise.resolve(n(D(e),32,{info:r,hash:"SHA-256"})).then(function(e){return new K(e)})})}catch(e){return Promise.reject(e)}}(l.password,""+a,JSON.stringify(l.wallet.getPrivateKey()))).then(function(e){return x(function(){return Promise.resolve(l.decryptToJson(t,s,e)).then(function(t){return l.driveKeyCache[""+a]=e,h=1,t})},function(){})})}();return f&&f.then?f.then(function(e){return h?e:u}):h?f:u},l=this,h=l.driveKeyForDriveId(a);if(h)return Promise.resolve(l.decryptToJson(t,s,h));var f=function(e,t,r){if("function"==typeof e[E]){var n,i,o,a=e[E]();if(function e(s){try{for(;!((n=a.next()).done||r&&r());)if((s=t(n.value))&&s.then){if(!N(s))return void s.then(e,o||(o=A.bind(null,i=new C,2)));s=s.v}i?A(i,1,s):i=s}catch(e){A(i||(i=new C),2,e)}}(),a.return){var s=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(s,function(e){throw s(e)});s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,r){var n,i,o=-1;return function a(s){try{for(;++o<e.length&&(!r||!r());)if((s=t(o))&&s.then){if(!N(s))return void s.then(a,i||(i=A.bind(null,n=new C,2)));s=s.v}n?A(n,1,s):n=s}catch(e){A(n||(n=new C),2,e)}}(),n}(u,function(e){return t(u[e])},r)}(l.unverifiedDriveKeys,function(e){return x(function(){return Promise.resolve(l.decryptToJson(t,s,e)).then(function(t){return l.driveKeyCache[""+a]=e,l.unverifiedDriveKeys=l.unverifiedDriveKeys.filter(function(t){return t!==e}),c=1,t})},function(){})},function(){return c});return Promise.resolve(f&&f.then?f.then(d):d(f))}catch(e){return Promise.reject(e)}},a.decryptToJson=function(e,t,n){try{return Promise.resolve(function(e,t,n){try{try{var i=n.slice(n.length-16),o=n.slice(0,n.length-16),a=S(e),s=S(D(t.keyData)),u=r.createDecipheriv("aes-256-gcm",s,a,{authTagLength:16});u.setAuthTag(i);for(var c=[],d=u.update(o);d.length>0;)c.push(d),d=u.update(new Uint8Array(16));var l=u.final();l.length>0&&c.push(l);var h=function(e){for(var t,r=0,n=v(e);!(t=n()).done;)r+=t.value.length;for(var i,o=new Uint8Array(r),a=0,s=v(e);!(i=s()).done;){var u=i.value;o.set(u,a),a+=u.length}return o}(c);return Promise.resolve(h)}catch(e){return console.error("Error decrypting file data"),Promise.resolve(new Uint8Array([69,114,114,111,114]))}}catch(e){return Promise.reject(e)}}(e,n,t)).then(function(e){return Promise.resolve(Q(e))})}catch(e){return Promise.reject(e)}},a.driveKeyForDriveId=function(e){var t;return null!=(t=this.driveKeyCache[""+e])&&t},t}(),k=/^[a-f\d]{8}-([a-f\d]{4}-){3}[a-f\d]{12}$/i;O=Symbol.toPrimitive;var J=/*#__PURE__*/function(){function e(e){if(this.entityId=void 0,this.entityId=e,e&&e.length&&!k.test(e.toString())&&"ENCRYPTED"!==e)throw new Error("Invalid entity ID '"+e+"'!'")}var t=e.prototype;return t[O]=function(e){if("number"===e)throw new Error("Entity IDs cannot be interpreted as a number!");return this.toString()},t.toString=function(){return this.entityId},t.valueOf=function(){return this.entityId},t.equals=function(e){return this.entityId===e.entityId},t.toJSON=function(){return this.toString()},e}();function V(e){return new J(e)}q=Symbol.toPrimitive;var _=/*#__PURE__*/function(){function e(e){if(this.unixTime=void 0,this.unixTime=e,this.unixTime<0||!Number.isInteger(this.unixTime)||!Number.isFinite(this.unixTime))throw new Error("Unix time must be a positive integer!")}var t=e.prototype;return t.equals=function(e){return+this.unixTime==+e.unixTime},t[q]=function(e){return"string"===e&&this.toString(),this.unixTime},t.toString=function(){return""+this.unixTime},t.valueOf=function(){return this.unixTime},t.toJSON=function(){return this.unixTime},e}(),K=/*#__PURE__*/function(){function e(e){if(this.keyData=void 0,this.keyData=e,!(e instanceof Uint8Array))throw new Error("The argument must be of type Uint8Array, got "+typeof e)}var t=e.prototype;return t.toString=function(){return function(e){for(var t="",r=new Uint8Array(e),n=r.byteLength,i=0;i<n;i++)t+=String.fromCharCode(r[i]);return btoa(t)}(this.keyData).replace(/=/g,"")},t.toJSON=function(){return this.toString()},e}(),U=function(e,t,r,n,i,o,a,s,u,c,d){this.appName=void 0,this.appVersion=void 0,this.arFS=void 0,this.contentType=void 0,this.driveId=void 0,this.entityType=void 0,this.name=void 0,this.txId=void 0,this.unixTime=void 0,this.customMetaDataGqlTags=void 0,this.customMetaDataJson=void 0,this.appName=e,this.appVersion=t,this.arFS=r,this.contentType=n,this.driveId=i,this.entityType=o,this.name=a,this.txId=s,this.unixTime=u,this.customMetaDataGqlTags=c,this.customMetaDataJson=d},G=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,s,u,c,d,l,h,f,v,p,y,m){var g;return(g=e.call(this,t,r,n,i,o,a,s,c,d,y,m)||this).entityType=void 0,g.size=void 0,g.lastModifiedDate=void 0,g.dataTxId=void 0,g.dataContentType=void 0,g.parentFolderId=void 0,g.entityId=void 0,g.entityType=a,g.size=u,g.lastModifiedDate=l,g.dataTxId=h,g.dataContentType=f,g.parentFolderId=v,g.entityId=p,g}return l(t,e),t}(U),z=/*#__PURE__*/function(){function e(e){var t=e.entityId,r=e.gatewayApi,n=e.owner;this.appName=void 0,this.appVersion=void 0,this.arFS=void 0,this.contentType=void 0,this.driveId=void 0,this.entityType=void 0,this.name=void 0,this.txId=void 0,this.unixTime=void 0,this.entityId=void 0,this.gatewayApi=void 0,this.owner=void 0,this.customMetaData={},this.entityId=t,this.gatewayApi=r,this.owner=n}var t=e.prototype;return t.getDataForTxID=function(e){try{return Promise.resolve(this.gatewayApi.getTxData(e))}catch(e){return Promise.reject(e)}},t.parseFromArweaveNode=function(e,t){try{var r=function(t){n.txId=M(e.id);var r=e.tags;if(!r)throw new Error("Tags missing!");return r.forEach(function(e){var t=e.value;switch(e.name){case"App-Name":n.appName=t;break;case"App-Version":n.appVersion=t;break;case"ArFS":n.arFS=t;break;case"Content-Type":n.contentType=t;break;case"Drive-Id":n.driveId=V(t);break;case"Entity-Type":n.entityType=t;break;case"Unix-Time":n.unixTime=new _(+t);break;default:i.push(e)}}),i},n=this,i=[],o=function(){if(!e){var r=H({tags:n.getGqlQueryParameters(),owner:t});return Promise.resolve(n.gatewayApi.gqlRequest(r)).then(function(t){var r=t.edges;if(!r.length)throw new Error("Entity with ID "+n.entityId+" not found!");e=r[0].node})}}();return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},t.build=function(e){try{var t=this;return Promise.resolve(t.parseFromArweaveNode(e,t.owner)).then(function(e){if(!e)throw new Error("Tags missing!");return t.parseCustomMetaDataFromGqlTags(e),t.buildEntity()})}catch(e){return Promise.reject(e)}},t.parseCustomMetaDataFromGqlTags=function(e){for(var t,r={},n=v(e);!(t=n()).done;){var i,o=t.value,a=o.name,s=o.value,u=r[a],c=u?Array.isArray(u)?[].concat(u,[s]):[u,s]:s;Object.assign(r,((i={})[a]=c,i))}!function(e){if("object"!=typeof e||null===e)return!1;for(var t=0,r=Object.entries(e);t<r.length;t++){var n=r[t],i=n[0],o=n[1];if(B.protectedArFSGqlTagNames.includes(i))return console.error("Provided custom metadata GQL tag name collides with a protected ArFS protected tag: "+i),!1;if("string"!=typeof o){if(!Array.isArray(o))return!1;for(var a,s=v(o);!(a=s()).done;){var u=a.value;if("string"!=typeof u)return!1;$(u)}}else $(o)}return!0}(r)?console.error("Parsed an invalid custom metadata shape from MetaData Tx GQL Tags: "+r):Object.keys(r).length>0&&(this.customMetaData.metaDataGqlTags=r)},t.parseCustomMetaDataFromDataJson=function(e){var t=this;if(function(e){try{JSON.parse(JSON.stringify(e))}catch(e){return!1}return!0}(e)){for(var r,n={},i=v(Object.entries(e).filter(function(e){return!t.protectedDataJsonKeys.includes(e[0])}));!(r=i()).done;){var o,a=r.value;Object.assign(n,((o={})[a[0]]=a[1],o))}Object.keys(n).length>0&&(this.customMetaData.metaDataJson=n)}else console.error("Parsed an invalid custom metadata shape from MetaData Tx Data JSON: "+e)},e}(),L=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).parentFolderId=void 0,t}return l(t,e),t.prototype.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){if(!e)throw new Error("Tags missing!");return e.forEach(function(e){"Parent-Folder-Id"===e.name?r.parentFolderId=V(e.value):n.push(e)}),n})}catch(e){return Promise.reject(e)}},t}(z),B=/*#__PURE__*/function(){function e(e){var t=e.appName,r=void 0===t?"default":t,n=e.appVersion,i=void 0===n?"default":n,o=e.arFSVersion,a=void 0===o?"default":o;this.appName=void 0,this.appVersion=void 0,this.arFSVersion=void 0,this.appName=r,this.appVersion=i,this.arFSVersion=a}return e.prototype.getFileDataItemTags=function(e,t){var r=this.baseAppTags;return r.push.apply(r,e?[ve,pe,ye]:[{name:"Content-Type",value:t}]),r},c(e,[{key:"baseAppTags",get:function(){return[{name:"App-Name",value:this.appName},{name:"App-Version",value:this.appVersion}]}},{key:"baseArFSTags",get:function(){return[].concat(this.baseAppTags,[{name:"ArFS",value:this.arFSVersion}])}},{key:"baseBundleTags",get:function(){return[].concat(this.baseAppTags,[{name:"Bundle-Format",value:"binary"},{name:"Bundle-Version",value:"2.0.0"}])}}]),e}();B.protectedArFSGqlTagNames=F,d({},{created:[],tips:[],fees:{}},{manifest:{},links:[]});var Q=function(e){try{var t,r,n,i,o;t="";var a=e.length;for(r=0;r<a;)switch((n=e[r++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:i=e[r++],t+=String.fromCharCode((31&n)<<6|63&i);break;case 14:i=e[r++],o=e[r++],t+=String.fromCharCode((15&n)<<12|(63&i)<<6|(63&o)<<0)}return Promise.resolve(t)}catch(e){return Promise.reject(e)}};function H(e){var t=e.tags,r=e.cursor,n=e.owner,i=e.sort,o=void 0===i?"HEIGHT_DESC":i,a=e.ids,s="";(void 0===t?[]:t).forEach(function(e){s=s+'\n\t\t\t\t{ name: "'+e.name+'", values: '+(Array.isArray(e.value)?"["+e.value.map(function(e){return'"'+e.toString()+'"'})+"]":'["'+e.value.toString()+'"]')+" }"});var u=void 0===r;return{query:"query {\n\t\t\ttransactions(\n\t\t\t\t"+(null!=a&&a.length?"ids: ["+a.map(function(e){return'"'+e+'"'})+"]":"")+"\n\t\t\t\tfirst: "+(u?1:100)+"\n\t\t\t\tsort: "+o+"\n\t\t\t\t"+(u?"":'after: "'+r+'"')+"\n\t\t\t\t"+(void 0===n?"":'owners: ["'+n.toString()+'"]')+"\n\t\t\t\ttags: [\n\t\t\t\t\t"+s+"\n\t\t\t\t]\n\t\t\t) {\n\t\t\t\t"+(u?"":"\n\tpageInfo {\n\t\thasNextPage\n\t}\n")+"\n\t\t\t\t"+T(u)+"\n\t\t\t}\n\t\t}"}}function W(e){var t,r,n=null!=(t=e.api.config.protocol)?t:ge,i=null!=(r=e.api.config.host)?r:me;return new URL(n+"://"+i+(e.api.config.port?":"+e.api.config.port:"")+"/")}function $(e){if(0===e.length)throw Error("Metadata string must be at least one character!")}function Y(e,t,r){var n=r.filter(function(t){return t.entityId.equals(e.entityId)});return e.txId.equals(n[0].txId)}function Z(e,t,r){var n=r.filter(function(t){return t.driveId.equals(e.driveId)});return e.txId.equals(n[0].txId)}function X(e){return(new TextEncoder).encode(e).buffer}var ee=/*#__PURE__*/function(){function e(e,t){var r=this;this.dbPromise=void 0,this.cache=void 0,this._gatewayApi=void 0,this.dbPromise=this.initDatabase(e),this.dbPromise.then(function(e){r.cache=e}),this._gatewayApi=new w({gatewayUrl:W(null!=t?t:s.init({}))})}var t=e.prototype;return t.cacheKeyString=function(e){if("string"==typeof e)return e;if(e instanceof J||e instanceof j)return e.toString();if("driveId"in e){var t="string"==typeof e.driveId?e.driveId:e.driveId.toString();return e.owner?JSON.stringify({driveId:t,owner:e.owner}):JSON.stringify({driveId:t})}if("folderId"in e){var r=e.folderId.toString();return e.owner?JSON.stringify({folderId:r,owner:e.owner}):JSON.stringify({folderId:r})}if("fileId"in e){var n=e.fileId.toString();return e.owner?JSON.stringify({fileId:n,owner:e.owner}):JSON.stringify({fileId:n})}if("entityId"in e)return e.entityId.toString();throw new Error("Unsupported cache key type: "+typeof e+" : "+JSON.stringify(e))},t.initDatabase=function(e){try{return Promise.resolve(new Promise(function(e,t){var r=indexedDB.open("arfs-entity-cache-db",1);r.onerror=function(e){console.debug(e),t(r.error)},r.onupgradeneeded=function(e){var t=r.result.createObjectStore("cache",{keyPath:"key"});t.createIndex("key","key",{unique:!0}),t.createIndex("value","value")},r.onsuccess=function(t){console.debug(t),e(r.result)}}))}catch(e){return Promise.reject(e)}},t.put=function(e,t){try{var r=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return console.log("put",{cacheKey:r}),new Promise(function(n,i){var o=e.transaction("cache","readwrite").objectStore("cache").put({key:r.toString(),value:t});o.onsuccess=function(e){n(t)},o.onerror=function(e){console.debug("Error putting in entity cache"),i(o.error)}})})}catch(e){return Promise.reject(e)}},t.get=function(e){try{var t=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return console.log("get",{cacheKey:t}),new Promise(function(r,n){var i=e.transaction("cache","readonly").objectStore("cache").index("key").get(t);i.onsuccess=function(e){var t=i.result;r(t?t.value:void 0)},i.onerror=function(e){n(i.error)}})})}catch(e){return Promise.reject(e)}},t.remove=function(e){try{var t=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(r,n){var i=e.transaction("cache","readwrite").objectStore("cache"),o=i.index("key").getKey(t);o.onsuccess=function(e){var t=o.result;if(void 0!==t){var a=i.delete(t);a.onsuccess=function(){r()},a.onerror=function(){console.debug(e),n(a.error)}}else r()},o.onerror=function(e){console.debug(e),n(o.error)}})})}catch(e){return Promise.reject(e)}},t.clear=function(){try{return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(t,r){var n=e.transaction("cache","readwrite").objectStore("cache").clear();n.onsuccess=function(e){console.debug(e),t()},n.onerror=function(e){console.debug(e),r(n.error)}})})}catch(e){return Promise.reject(e)}},t.size=function(){try{return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(t,r){var n=e.transaction("cache","readonly").objectStore("cache").count();n.onsuccess=function(e){console.debug(e),t(n.result)},n.onerror=function(e){console.debug(e),r(n.error)}})})}catch(e){return Promise.reject(e)}},e}(),te=/*#__PURE__*/function(){function e(){}return e.platformCacheFolder=function(){return"metadata"},e.initDatabase=function(){try{return Promise.resolve(new Promise(function(e,t){var r=indexedDB.open("arfs-metadata-cache-db",1);r.onerror=function(e){console.debug(e),t(r.error)},r.onupgradeneeded=function(e){var t=r.result.createObjectStore("cache",{keyPath:"txId"});t.createIndex("txId","txId",{unique:!0}),t.createIndex("buffer","buffer")},r.onsuccess=function(t){console.debug(t),e(r.result)}}))}catch(e){return Promise.reject(e)}},e.getCacheFolder=function(){try{var e=this;return e.cacheFolderPromise||(e.cacheFolderPromise=new Promise(function(t){t(e.metadataCacheFolder)})),Promise.resolve(e.cacheFolderPromise)}catch(e){return Promise.reject(e)}},e.put=function(e,t){try{return Promise.resolve(this.getDatabase()).then(function(r){return new Promise(function(n,i){var o=r.transaction("cache","readwrite").objectStore("cache").put({txId:e.toString(),buffer:t});o.onsuccess=function(e){console.debug(e),n()},o.onerror=function(e){console.debug(e),i(o.error)}})})}catch(e){return Promise.reject(e)}},e.get=function(e){try{return Promise.resolve(this.getDatabase()).then(function(t){return new Promise(function(r,n){var i=t.transaction("cache","readonly").objectStore("cache").index("txId").get(e.toString());i.onsuccess=function(e){var t=i.result;t?(console.debug(e,t),r(t.buffer)):r(void 0)},i.onerror=function(e){console.debug(e),n(i.error)}})})}catch(e){return Promise.reject(e)}},e.getDatabase=function(){try{var e=this;return e.dbPromise||(e.dbPromise=e.initDatabase()),Promise.resolve(e.dbPromise)}catch(e){return Promise.reject(e)}},e}();te.cacheFolderPromise=void 0,te.shouldCacheLog="1"===process.env.ARDRIVE_CACHE_LOG,te.metadataCacheFolder=te.platformCacheFolder(),te.logTag="[Metadata Cache] ",te.dbPromise=void 0;var re={ownerCache:new ee(10),driveIdCache:new ee(10),publicDriveCache:new ee(10),publicFolderCache:new ee(10),publicFileCache:new ee(10)},ne=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,s,u,c,d,l,h,f,v,p,y){var m;return(m=e.call(this,t,r,n,i,o,"file",a,l,s,u,h,f,v,c,d,p,y)||this).fileId=void 0,m.fileId=d,m}return l(t,e),t}(G),ie=/*#__PURE__*/function(e){function t(t,r){var n;return(n=e.call(this,t.appName,t.appVersion,t.arFS,t.contentType,t.driveId,t.name,t.txId,t.unixTime,t.parentFolderId,t.fileId,t.size,t.lastModifiedDate,t.dataTxId,t.dataContentType,t.customMetaDataGqlTags,t.customMetaDataJson)||this).path=void 0,n.txIdPath=void 0,n.entityIdPath=void 0,n.path=""+r.pathToFolderId(t.parentFolderId)+t.name,n.txIdPath=""+r.txPathToFolderId(t.parentFolderId)+t.txId,n.entityIdPath=""+r.entityPathToFolderId(t.parentFolderId)+t.fileId,n}return l(t,e),t}(ne),oe=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return l(t,e),t.fromArweaveNode=function(e,r){var n,i=e.tags;if(!i)throw new Error("Tags missing!");var o=null==(n=i.find(function(e){return"File-Id"===e.name}))?void 0:n.value;if(!o)throw new Error("File-ID tag missing!");return new t({entityId:V(o),gatewayApi:r})},t.prototype.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid file state")},r=this,n=function(){var t,n,i,o,s;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(s=r.entityType)&&s.length&&r.txId&&r.unixTime&&r.parentFolderId&&r.entityId)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(Q(new Uint8Array(t))).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){var n;if(r.name=t.name,r.size=new b(t.size),r.lastModifiedDate=new _(t.lastModifiedDate),r.dataTxId=new j(t.dataTxId),r.dataContentType=null!=(n=t.dataContentType)?n:function(e){var t=e.substring(e.lastIndexOf(".")+1);t=t.toLowerCase();var r=a.lookup(t);return!1===r?"unknown":r}(r.name),!(r.name&&void 0!==r.size&&r.lastModifiedDate&&r.dataTxId&&r.dataContentType&&"file"===r.entityType))throw new Error("Invalid file state");r.parseCustomMetaDataFromDataJson(t);var i=Promise.resolve(new ne(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.name,r.txId,r.unixTime,r.parentFolderId,r.entityId,r.size,r.lastModifiedDate,r.dataTxId,r.dataContentType,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson));return e=1,i})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).size=void 0,t.lastModifiedDate=void 0,t.dataTxId=void 0,t.dataContentType=void 0,t.protectedDataJsonKeys=["name","size","lastModifiedDate","dataTxId","dataContentType"],t}l(t,e);var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"File-Id",value:""+this.entityId},{name:"Entity-Type",value:"file"}]},r.parseFromArweaveNode=function(t){try{return Promise.resolve(e.prototype.parseFromArweaveNode.call(this,t)).then(function(e){if(!e)throw new Error("Tags missing!");return e.filter(function(e){return"File-Id"!==e.name})})}catch(e){return Promise.reject(e)}},t}(L));new b(2147483646);var ae=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,s,u,c,d,l,h){var f;return(f=e.call(this,t,r,n,i,o,"folder",a,new b(0),s,u,new _(0),Fe,fe,c,d,l,h)||this).folderId=void 0,f.folderId=d,f}return l(t,e),t}(G),se=/*#__PURE__*/function(e){function t(t,r){var n;return(n=e.call(this,t.appName,t.appVersion,t.arFS,t.contentType,t.driveId,t.name,t.txId,t.unixTime,t.parentFolderId,t.folderId,t.customMetaDataGqlTags,t.customMetaDataJson)||this).path=void 0,n.txIdPath=void 0,n.entityIdPath=void 0,n.path=""+r.pathToFolderId(t.parentFolderId)+t.name,n.txIdPath=""+r.txPathToFolderId(t.parentFolderId)+t.txId,n.entityIdPath=""+r.entityPathToFolderId(t.parentFolderId)+t.folderId,n}return l(t,e),t}(ae),ue=/*#__PURE__*/function(){function e(e,t,r){void 0===r&&(r=[]),this.folderId=void 0,this.parent=void 0,this.children=void 0,this.folderId=e,this.parent=t,this.children=r}return e.fromEntity=function(t){return new e(t.entityId)},e}(),ce=/*#__PURE__*/function(){function e(e,t){this.folderIdToEntityMap=void 0,this.folderIdToNodeMap=void 0,this._rootNode=void 0,this.folderIdToEntityMap=e,this.folderIdToNodeMap=t}e.newFromEntities=function(t){for(var r,n=t.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.entityId]=t,r))},{}),i={},o=v(t);!(r=o()).done;)this.setupNodesWithEntity(r.value,n,i);return new e(n,i)},e.setupNodesWithEntity=function(e,t,r){var n=Object.keys(r).includes(""+e.entityId),i=Object.keys(r).includes(""+e.parentFolderId);if(!n){if(!i){var o=t[""+e.parentFolderId];o&&this.setupNodesWithEntity(o,t,r)}var a=r[""+e.parentFolderId];if(a){var s=new ue(e.entityId,a);a.children.push(s),r[""+e.entityId]=s}else{var u=new ue(e.entityId);r[""+e.entityId]=u}}};var t=e.prototype;return t.subTreeOf=function(t,r){var n=this;void 0===r&&(r=Number.MAX_SAFE_INTEGER);var i=this.nodeAndChildrenOf(this.folderIdToNodeMap[""+t],r);return new e(i.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.folderId]=n.folderIdToEntityMap[""+t.folderId],r))},{}),i.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.folderId]=t,r))},{}))},t.allFolderIDs=function(){return Object.keys(this.folderIdToEntityMap).map(function(e){return V(e)})},t.nodeAndChildrenOf=function(e,t){var r=this,n=[e];return t>0&&e.children.forEach(function(e){n.push.apply(n,r.nodeAndChildrenOf(e,t-1))}),n},t.folderIdSubtreeFromFolderId=function(e,t){var r=this,n=this.folderIdToNodeMap[""+e],i=[n.folderId];return 0===t||n.children.map(function(e){return e.folderId}).forEach(function(e){i.push.apply(i,r.folderIdSubtreeFromFolderId(e,t-1))}),i},t.pathToFolderId=function(e){var t=this;if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===Ie)return"/";for(var r=this.folderIdToNodeMap[""+e],n=[r];r.parent&&!r.folderId.equals(this.rootNode.folderId);)n.push(r=r.parent);return"/"+n.reverse().map(function(e){return t.folderIdToEntityMap[""+e.folderId].name}).join("/")+"/"},t.entityPathToFolderId=function(e){if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===Ie)return"/";for(var t=this.folderIdToNodeMap[""+e],r=[t];t.parent&&!t.folderId.equals(this.rootNode.folderId);)r.push(t=t.parent);return"/"+r.reverse().map(function(e){return e.folderId}).join("/")+"/"},t.txPathToFolderId=function(e){var t=this;if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===Ie)return"/";for(var r=this.folderIdToNodeMap[""+e],n=[r];r.parent&&!r.folderId.equals(this.rootNode.folderId);)n.push(r=r.parent);return"/"+n.reverse().map(function(e){return t.folderIdToEntityMap[""+e.folderId].txId}).join("/")+"/"},c(e,[{key:"rootNode",get:function(){if(this._rootNode)return this._rootNode;for(var e=Object.keys(this.folderIdToEntityMap)[0],t=this.folderIdToNodeMap[e];t.parent&&this.folderIdToNodeMap[""+t.parent.folderId];)t=t.parent;return this._rootNode=t,t}}]),e}(),de=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).protectedDataJsonKeys=["name"],t}l(t,e);var r=t.prototype;return r.parseFromArweaveNode=function(t){try{return Promise.resolve(e.prototype.parseFromArweaveNode.call(this,t)).then(function(e){if(!e)throw new Error("Tags missing!");return e.filter(function(e){return"Folder-Id"!==e.name})})}catch(e){return Promise.reject(e)}},r.getGqlQueryParameters=function(){return[{name:"Folder-Id",value:""+this.entityId},{name:"Entity-Type",value:"folder"}]},t}(L),le=/*#__PURE__*/function(e){function t(){var t;return(t=e.call(this,""+De)||this).entityId=Ie,t}return l(t,e),t}(J),he=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return l(t,e),t.fromArweaveNode=function(e,r){var n,i=e.tags;if(!i)throw new Error("Tags missing!");var o=null==(n=i.find(function(e){return"Folder-Id"===e.name}))?void 0:n.value;if(!o)throw new Error("Folder-ID tag missing!");return new t({entityId:V(o),gatewayApi:r})},t.prototype.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid public folder state")},r=this;r.parentFolderId||(r.parentFolderId=new le);var n=function(){var t,n,i,o,a;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.parentFolderId&&r.entityId&&"folder"===r.entityType)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(Q(new Uint8Array(t))).then(function(t){var n=JSON.parse(t);if(r.name=n.name,!r.name)throw new Error("Invalid public folder state: name not found!");r.parseCustomMetaDataFromDataJson(n);var i=Promise.resolve(new ae(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.name,r.txId,r.unixTime,r.parentFolderId,r.entityId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson));return e=1,i})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(de),fe="application/json",ve={name:"Content-Type",value:"application/octet-stream"},pe={name:"Cipher",value:"AES256-GCM"},ye={name:"Cipher-IV",value:"qwertyuiopasdfgh"},me="arweave.net",ge="https",Ie="root folder",we="ENCRYPTED",Pe=500,be=["invalid_json","chunk_too_big","data_path_too_big","offset_too_big","data_size_too_big","chunk_proof_ratio_not_attractive","invalid_proof"],Te={arFS:"ArFS",tipType:"Tip-Type",contentType:"Content-Type",boost:"Boost",bundleFormat:"Bundle-Format",bundleVersion:"Bundle-Version",entityType:"Entity-Type",unitTime:"Unix-Time",driveId:"Drive-Id",folderId:"Folder-Id",fileId:"File-Id",parentFolderId:"Parent-Folder-Id",drivePrivacy:"Drive-Privacy",cipher:"Cipher",cipherIv:"Cipher-IV",driveAuthMode:"Drive-Auth-Mode"},Fe=new j("0000000000000000000000000000000000000000000"),De=V("00000000-0000-0000-0000-000000000000"),Se=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,s,u,c,d,l,h,f){var v;return(v=e.call(this,t,r,n,i,o,a,s,u,c,h,f)||this).appName=void 0,v.appVersion=void 0,v.arFS=void 0,v.contentType=void 0,v.driveId=void 0,v.entityType=void 0,v.name=void 0,v.txId=void 0,v.unixTime=void 0,v.drivePrivacy=void 0,v.rootFolderId=void 0,v.appName=t,v.appVersion=r,v.arFS=n,v.contentType=i,v.driveId=o,v.entityType=a,v.name=s,v.txId=u,v.unixTime=c,v.drivePrivacy=d,v.rootFolderId=l,v}return l(t,e),t}(U),xe=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,s,u,c,d,l,h,f,v,p,y,m){var g;return(g=e.call(this,t,r,n,i,o,a,s,u,c,y,m)||this).appName=void 0,g.appVersion=void 0,g.arFS=void 0,g.contentType=void 0,g.driveId=void 0,g.entityType=void 0,g.name=void 0,g.txId=void 0,g.unixTime=void 0,g.drivePrivacy=void 0,g.rootFolderId=void 0,g.driveAuthMode=void 0,g.cipher=void 0,g.cipherIV=void 0,g.driveKey=void 0,g.appName=t,g.appVersion=r,g.arFS=n,g.contentType=i,g.driveId=o,g.entityType=a,g.name=s,g.txId=u,g.unixTime=c,g.drivePrivacy=d,g.rootFolderId=l,g.driveAuthMode=h,g.cipher=f,g.cipherIV=v,g.driveKey=p,g}return l(t,e),t}(U),Ee=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).protectedDataJsonKeys=["name","rootFolderId"],t}return l(t,e),t}(z),Ae=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).drivePrivacy=void 0,t.rootFolderId=void 0,t}l(t,e),t.fromArweaveNode=function(e,r){var n,i=e.tags;if(!i)throw new Error("Tags missing!");var o=null==(n=i.find(function(e){return"Drive-Id"===e.name}))?void 0:n.value;if(!o)throw new Error("Drive-ID tag missing!");return new t({entityId:V(o),gatewayApi:r})};var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"Drive-Id",value:""+this.entityId},{name:"Entity-Type",value:"drive"},{name:"Drive-Privacy",value:"public"}]},r.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){if(!e)throw new Error("Tags missing!");return e.forEach(function(e){"Drive-Privacy"===e.name?r.drivePrivacy=e.value:n.push(e)}),n})}catch(e){return Promise.reject(e)}},r.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid drive state")},r=this,n=function(){var t,n,i,o,a,s;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.driveId.equals(r.entityId)&&null!=(s=r.drivePrivacy)&&s.length)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(Q(new Uint8Array(t))).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){if(r.name=t.name,r.rootFolderId=t.rootFolderId,!r.name||!r.rootFolderId)throw new Error("Invalid drive state");r.parseCustomMetaDataFromDataJson(t);var n=new Se(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,n})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(Ee),Ce=/*#__PURE__*/function(e){function t(t){var r,n=t.privateKeyData;return(r=e.call(this,{entityId:t.entityId,gatewayApi:t.gatewayApi})||this).drivePrivacy=void 0,r.rootFolderId=void 0,r.driveAuthMode=void 0,r.cipher=void 0,r.cipherIV=void 0,r.privateKeyData=void 0,r.privateKeyData=n,r}l(t,e);var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"Drive-Id",value:""+this.entityId},{name:"Entity-Type",value:"drive"}]},t.fromArweaveNode=function(e,r,n){var i,o=e.tags;if(!o)throw new Error("Tags missing!");var a=null==(i=o.find(function(e){return"Drive-Id"===e.name}))?void 0:i.value;if(!a)throw new Error("Drive-ID tag missing!");return new t({entityId:V(a),privateKeyData:n,gatewayApi:r})},r.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){if(!e)throw new Error("Tags missing!");return e.forEach(function(e){var t=e.value;switch(e.name){case"Cipher":r.cipher=t;break;case"Cipher-IV":r.cipherIV=t;break;case"Drive-Auth-Mode":r.driveAuthMode=t;break;case"Drive-Privacy":r.drivePrivacy=t;break;default:n.push(e)}}),n})}catch(e){return Promise.reject(e)}},r.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid drive state")},r=this,n=function(){var t,n,i,o,a,s;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&null!=(s=r.drivePrivacy)&&s.length){var u="private"===r.drivePrivacy;return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){var n=new Uint8Array(t);return Promise.resolve(function(){try{if(u){var e,i,o;if(null!=(e=r.cipher)&&e.length&&null!=(i=r.driveAuthMode)&&i.length&&null!=(o=r.cipherIV)&&o.length)return Promise.resolve(r.privateKeyData.safelyDecryptToJson(r.cipherIV,r.entityId,n,{name:we,rootFolderId:we}));throw new Error("Invalid private drive state")}return Promise.resolve(Q(new Uint8Array(t))).then(function(e){return JSON.parse(e)})}catch(e){return Promise.reject(e)}}()).then(function(t){if(r.name=t.name,r.rootFolderId=V(t.rootFolderId),r.parseCustomMetaDataFromDataJson(t),u){if(!r.driveAuthMode||!r.cipher||!r.cipherIV)throw new Error("Unexpectedly null privacy data for private drive with ID "+r.driveId+"!");var n=new Ne(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.driveAuthMode,r.cipher,r.cipherIV,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,n}var i=new Se(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,i})})}}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(Ee),Ne=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,s,u,c,d,l,h,f,v,p,y){var m;return(m=e.call(this,t,r,n,i,o,a,s,u,c,d,l,h,f,v,new K(new Uint8Array([])),p,y)||this).driveKey=void 0,m.driveKey=new K(new Uint8Array([])),delete m.driveKey,m}return l(t,e),t}(xe);function je(e,t,r){if(!e.s){if(r instanceof Oe){if(!r.s)return void(r.o=je.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(je.bind(null,e,t),je.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var Me=/*#__PURE__*/function(){function e(e,t,r){void 0===t&&(t=re),void 0===r&&(r=new w({gatewayUrl:W(e)})),this.caches=void 0,this.gatewayApi=void 0,this._arweave=void 0,this._gatewayApi=void 0,this._caches=void 0,this.appName=void 0,this.appVersion=void 0,this.caches=t,this.gatewayApi=r,this._arweave=e,this._gatewayApi=r,this._caches=t,this.appName="ArFS",this.appVersion="0.0.1"}var t=e.prototype;return t.getOwnerForDriveId=function(e){try{var t=this;return Promise.resolve(t.caches.ownerCache.get(e)).then(function(r){if(r)return r;var n=t.caches.ownerCache,i=n.put;return Promise.resolve(function(){try{var r=H({tags:[{name:"Drive-Id",value:""+e},{name:"Entity-Type",value:"drive"}],sort:"HEIGHT_ASC"});return Promise.resolve(t.gatewayApi.gqlRequest(r)).then(function(t){var r=t.edges;if(!r.length)throw new Error('Could not find a transaction with "Drive-Id": '+e.toString());return M(r[0].node.owner.address)})}catch(e){return Promise.reject(e)}}()).then(function(t){return i.call(n,e,t)})})}catch(e){return Promise.reject(e)}},t.getDriveIDForEntityId=function(e,t){try{var r=this;return console.log("getDriveIDForEntityId : get",e),Promise.resolve(r.caches.driveIdCache.get(e)).then(function(n){return n||Promise.resolve(function(){try{var n=H({tags:[{name:t,value:""+e}]});return Promise.resolve(r.gatewayApi.gqlRequest(n)).then(function(r){var n=r.edges;if(!n.length)throw new Error("Entity with "+t+" "+e.toString()+" not found!");var i=n[0].node.tags.find(function(e){return"Drive-Id"===e.name});if(i)return V(i.value);throw new Error("No Drive-Id tag found for meta data transaction of "+t+": "+e.toString())})}catch(e){return Promise.reject(e)}}).then(function(t){console.log("getDriveIDForEntityId : put",e);var n=r.caches.driveIdCache,i=n.put;return Promise.resolve(t()).then(function(t){return Promise.resolve(i.call(n,e,t))})})})}catch(e){return Promise.reject(e)}},t.getDriveOwnerForFolderId=function(e){try{var t=this,r=t.getOwnerForDriveId;return Promise.resolve(t.getDriveIdForFolderId(e)).then(function(e){return r.call(t,e)})}catch(e){return Promise.reject(e)}},t.getDriveIdForFolderId=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"Folder-Id"))}catch(e){return Promise.reject(e)}},t.getDriveOwnerForFileId=function(e){try{var t=this,r=t.getOwnerForDriveId;return Promise.resolve(t.getDriveIdForFileId(e)).then(function(e){return r.call(t,e)})}catch(e){return Promise.reject(e)}},t.getDriveIdForFileId=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"File-Id"))}catch(e){return Promise.reject(e)}},t.getDriveIdForEntityID=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"Folder-Id"))}catch(e){return Promise.reject(e)}},t.getPublicDrive=function(e){var t=e.driveId,r=e.owner;try{var n=this,i={driveId:t.toString(),owner:r};return Promise.resolve(n.caches.publicDriveCache.get(i)).then(function(e){if(e)return e;var o=n.caches.publicDriveCache,a=o.put;return Promise.resolve(new Ae({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()).then(function(e){return Promise.resolve(a.call(o,i,e))})})}catch(e){return Promise.reject(e)}},t.getPublicFolder=function(e){var t=e.folderId,r=e.owner;try{var n=this,i={folderId:t,owner:r};return console.log("getPublicFolder : get",{cacheKey:i}),Promise.resolve(n.caches.publicFolderCache.get(i)).then(function(e){if(e)return e;console.log("getPublicFolder : put",{cacheKey:i});var o=n.caches.publicFolderCache,a=o.put;return Promise.resolve(new he({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()).then(function(e){return Promise.resolve(a.call(o,i,e))})})}catch(e){return Promise.reject(e)}},t.getPublicFile=function(e){var t=e.fileId,r=e.owner;try{var n=this,i={fileId:t,owner:r};return console.log("getPublicFile : get",{cacheKey:i}),Promise.resolve(n.caches.publicFileCache.get(i)).then(function(e){if(e)return e;console.log("getPublicFile : put",{cacheKey:i});var o=n.caches.publicFileCache,a=o.put;return Promise.resolve(new oe({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()).then(function(e){return Promise.resolve(a.call(o,i,e))})})}catch(e){return Promise.reject(e)}},t.getAllDrivesForAddress=function(e){var t=e.address,r=e.privateKeyData,n=e.latestRevisionsOnly,i=void 0===n||n;try{var o=function(){return i?d.filter(Z):d},a=this,s=new j(t),u="",c=!0,d=[],l=Re(function(){return!!c},void 0,function(){var e=H({tags:[{name:"Entity-Type",value:"drive"}],cursor:u,owner:s});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){c=e.pageInfo.hasNextPage;var t=e.edges.map(function(e){try{var t=e.node;u=e.cursor;var n=Ce.fromArweaveNode(t,a.gatewayApi,r);return Promise.resolve(n.build(t)).then(function(e){if("public"===e.drivePrivacy){var t={driveId:e.driveId,owner:s},r=a.caches.publicDriveCache,n=r.put;return Promise.resolve(Promise.resolve(e)).then(function(e){return Promise.resolve(n.call(r,t,e))})}return Promise.resolve(e)})}catch(e){return Promise.reject(e)}}),n=d.push;return Promise.resolve(Promise.all(t)).then(function(e){n.call.apply(n,[d].concat(e))})})});return Promise.resolve(l&&l.then?l.then(o):o())}catch(e){return Promise.reject(e)}},t.getPublicFilesWithParentFolderIds=function(e){var t=e.folderIDs,r=e.owner,n=e.latestRevisionsOnly,i=void 0!==n&&n;try{var o=function(){return i?c.filter(Y):c},a=this,s="",u=!0,c=[],d=Re(function(){return!!u},void 0,function(){var e=H({tags:[{name:"Parent-Folder-Id",value:t.map(function(e){return e.toString()})},{name:"Entity-Type",value:"file"}],cursor:s,owner:r});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){u=e.pageInfo.hasNextPage;var t=e.edges.map(function(e){try{var t=e.node;s=e.cursor;var n=oe.fromArweaveNode(t,a.gatewayApi);return Promise.resolve(n.build(t)).then(function(e){var t={fileId:e.fileId,owner:r};c.push(e);var n=a.caches.publicFileCache,i=n.put;return Promise.resolve(Promise.resolve(e)).then(function(e){return Promise.resolve(i.call(n,t,e))})})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(t)).then(function(){})})});return Promise.resolve(d&&d.then?d.then(o):o())}catch(e){return Promise.reject(e)}},t.getAllFoldersOfPublicDrive=function(e){var t=e.driveId,r=e.owner,n=e.latestRevisionsOnly,i=void 0!==n&&n;try{var o=function(){return i?c.filter(Y):c},a=this,s="",u=!0,c=[],d=Re(function(){return!!u},void 0,function(){var e=H({tags:[{name:"Drive-Id",value:""+t.toString()},{name:"Entity-Type",value:"folder"}],cursor:s,owner:r});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){u=e.pageInfo.hasNextPage;var t=e.edges.map(function(e){try{var t=e.node;s=e.cursor;var n=he.fromArweaveNode(t,a.gatewayApi);return Promise.resolve(n.build(t)).then(function(e){var t={folderId:e.entityId,owner:r},n=a.caches.publicFolderCache,i=n.put;return Promise.resolve(Promise.resolve(e)).then(function(e){return Promise.resolve(i.call(n,t,e))})})}catch(e){return Promise.reject(e)}}),n=c.push;return Promise.resolve(Promise.all(t)).then(function(e){n.call.apply(n,[c].concat(e))})})});return Promise.resolve(d&&d.then?d.then(o):o())}catch(e){return Promise.reject(e)}},t.listPublicFolder=function(e){var t=e.folderId,r=e.maxDepth,n=e.includeRoot,i=e.owner;try{var o=this;if(!Number.isInteger(r)||r<0)throw new Error("maxDepth should be a non-negative integer!");return Promise.resolve(o.getPublicFolder({folderId:t,owner:i})).then(function(e){return Promise.resolve(o.getAllFoldersOfPublicDrive({driveId:e.driveId,owner:i,latestRevisionsOnly:!0})).then(function(a){function s(){for(var e,t=[],r=v(l);!(e=r()).done;)t.push(e.value);for(var n,i=v(h);!(n=i()).done;)t.push(n.value);var o=t.map(function(e){return function(e,t){return"folder"===e.entityType?new se(e,t):new ie(e,t)}(e,u)});return o}var u=ce.newFromEntities(a),c=u.folderIdSubtreeFromFolderId(t,r),d=u.folderIdSubtreeFromFolderId(t,r+1).slice(1),l=a.filter(function(e){return d.some(function(t){return t.equals(e.entityId)})});n&&l.unshift(e);var h=[],f=function(e,t,r){if("function"==typeof e[ke]){var n,i,o,a=e[ke]();if(function e(r){try{for(;!(n=a.next()).done;)if((r=t(n.value))&&r.then){if(!qe(r))return void r.then(e,o||(o=je.bind(null,i=new Oe,2)));r=r.v}i?je(i,1,r):i=r}catch(e){je(i||(i=new Oe),2,e)}}(),a.return){var s=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(s,function(e){throw s(e)});s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,r){var n,i,o=-1;return function r(a){try{for(;++o<e.length;)if((a=t(o))&&a.then){if(!qe(a))return void a.then(r,i||(i=je.bind(null,n=new Oe,2)));a=a.v}n?je(n,1,a):n=a}catch(e){je(n||(n=new Oe),2,e)}}(),n}(u,function(e){return t(u[e])})}(c,function(e){return Promise.resolve(o.getPublicFilesWithParentFolderIds({folderIDs:[e],owner:i,latestRevisionsOnly:!0})).then(function(e){e.forEach(function(e){h.push(e)})})});return f&&f.then?f.then(s):s()})})}catch(e){return Promise.reject(e)}},e}();const Oe=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,i=this.s;if(i){const e=1&i?t:r;if(e){try{je(n,1,e(this.v))}catch(e){je(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?je(n,1,t?t(i):i):r?je(n,1,r(i)):je(n,2,i)}catch(e){je(n,2,e)}},n},e}();function qe(e){return e instanceof Oe&&1&e.s}function Re(e,t,r){for(var n;;){var i=e();if(qe(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!qe(o)){n=1;break}o=o.s}if(t){var a=t();if(a&&a.then&&!qe(a)){n=2;break}}}var s=new Oe,u=je.bind(null,s,2);return(0===n?i.then(d):1===n?o.then(c):a.then(l)).then(void 0,u),s;function c(n){o=n;do{if(t&&(a=t())&&a.then&&!qe(a))return void a.then(l).then(void 0,u);if(!(i=e())||qe(i)&&!i.v)return void je(s,1,o);if(i.then)return void i.then(d).then(void 0,u);qe(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function d(e){e?(o=r())&&o.then?o.then(c).then(void 0,u):c(o):je(s,1,o)}function l(){(i=e())?i.then?i.then(d).then(void 0,u):d(i):je(s,1,o)}}var ke="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";export{Me as ArFSClient,Se as ArFSPublicDrive,ne as ArFSPublicFile,ae as ArFSPublicFolder,j as ArweaveAddress,J as EntityID,R as PrivateKeyData};
