require("uuid");var e=require("axios");require("crypto"),require("futoin-hkdf"),require("utf8"),require("jwk-to-pem"),require("base64-js");var t=require("mime-types");require("bignumber.js");var r=require("arweave");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var o,a=/*#__PURE__*/n(e),u=/*#__PURE__*/i(t),s=/*#__PURE__*/n(r);function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,"symbol"==typeof(i=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(n.key))?i:String(i),n)}var i}function d(e,t,r){return t&&c(e.prototype,t),r&&c(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(){return l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},l.apply(this,arguments)}function h(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,f(e,t)}function f(e,t){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},f(e,t)}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function p(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?v(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function m(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function y(e,t,r){if(!e.s){if(r instanceof I){if(!r.s)return void(r.o=y.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(y.bind(null,e,t),y.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var I=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{y(n,1,o(this.v))}catch(e){y(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?y(n,1,t?t(i):i):r?y(n,1,r(i)):y(n,2,i)}catch(e){y(n,2,e)}},n},e}();function g(e){return e instanceof I&&1&e.s}var w=/*#__PURE__*/function(){function e(e){var t=e.gatewayUrl,r=e.maxRetriesPerRequest,n=void 0===r?8:r,i=e.initialErrorDelayMS,o=void 0===i?he:i,u=e.fatalErrors,s=void 0===u?fe:u,c=e.validStatusCodes,d=void 0===c?[200]:c,l=e.axiosInstance,h=void 0===l?a.default.create({validateStatus:void 0}):l;this.gatewayUrl=void 0,this.maxRetriesPerRequest=void 0,this.initialErrorDelayMS=void 0,this.fatalErrors=void 0,this.validStatusCodes=void 0,this.axiosInstance=void 0,this.lastError="unknown error",this.lastRespStatus=0,this.gatewayUrl=t,this.maxRetriesPerRequest=n,this.initialErrorDelayMS=o,this.fatalErrors=s,this.validStatusCodes=d,this.axiosInstance=h}var t=e.prototype;return t.postChunk=function(e){try{return Promise.resolve(this.postToEndpoint("chunk",e)).then(function(){})}catch(e){return Promise.reject(e)}},t.postTxHeader=function(e){try{return Promise.resolve(this.postToEndpoint("tx",e)).then(function(){})}catch(e){return Promise.reject(e)}},t.gqlRequest=function(e){try{var t=this;return Promise.resolve(m(function(){return Promise.resolve(t.postToEndpoint("graphql",e)).then(function(e){return e.data.data.transactions})},function(e){throw Error("GQL Error: "+e.message)}))}catch(e){return Promise.reject(e)}},t.postToEndpoint=function(e,t){try{var r=this;return Promise.resolve(r.retryRequestUntilMaxRetries(function(){return r.axiosInstance.post(""+r.gatewayUrl.href+e,t)}))}catch(e){return Promise.reject(e)}},t.getTransaction=function(e){try{var t=this;return Promise.resolve(m(function(){return Promise.resolve(t.retryRequestUntilMaxRetries(function(){return t.axiosInstance.get(t.gatewayUrl.href+"tx/"+e)})).then(function(e){return e.data})},function(){throw Error("Transaction could not be found from the gateway: (Status: "+t.lastRespStatus+") "+t.lastError)}))}catch(e){return Promise.reject(e)}},t.getTxData=function(e){try{var t=this;return Promise.resolve(L.get(e)).then(function(r){return r||Promise.resolve(t.retryRequestUntilMaxRetries(function(){return t.axiosInstance.get(""+t.gatewayUrl.href+e,{responseType:"arraybuffer"})})).then(function(t){var r=t.data;return Promise.resolve(L.put(e,r)).then(function(){return r})})})}catch(e){return Promise.reject(e)}},t.retryRequestUntilMaxRetries=function(e){try{var t,r=function(e){if(t)return e;throw new Error("Request to gateway has failed: (Status: "+n.lastRespStatus+") "+n.lastError)},n=this,i=0,o=function(e,t,r){for(var n;;){var i=e();if(g(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!g(o)){n=1;break}o=o.s}if(t){var a=t();if(a&&a.then&&!g(a)){n=2;break}}}var u=new I,s=y.bind(null,u,2);return(0===n?i.then(d):1===n?o.then(c):a.then(l)).then(void 0,s),u;function c(n){o=n;do{if(t&&(a=t())&&a.then&&!g(a))return void a.then(l).then(void 0,s);if(!(i=e())||g(i)&&!i.v)return void y(u,1,o);if(i.then)return void i.then(d).then(void 0,s);g(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,s)}function d(e){e?(o=r())&&o.then?o.then(c).then(void 0,s):c(o):y(u,1,o)}function l(){(i=e())?i.then?i.then(d).then(void 0,s):d(i):y(u,1,o)}}(function(){return!t&&i<=n.maxRetriesPerRequest},void 0,function(){return Promise.resolve(n.tryRequest(e)).then(function(e){function r(){function e(){i=t}console.error("Request to gateway has failed: (Status: "+n.lastRespStatus+") "+n.lastError);var t=i+1,r=function(){if(t<=n.maxRetriesPerRequest)return Promise.resolve(n.exponentialBackOffAfterFailedRequest(i)).then(function(){console.error("Retrying request, retry attempt "+t+"...")})}();return r&&r.then?r.then(e):e()}if(e)return i>0&&console.error("Request has been successfully retried!"),t=1,e;n.throwIfFatalError();var o=function(){if(429===n.lastRespStatus)return Promise.resolve(n.rateLimitThrottle()).then(function(){})}();return o&&o.then?o.then(r):r()})});return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(e){return Promise.reject(e)}},t.tryRequest=function(e){try{var t,r=this,n=m(function(){return Promise.resolve(e()).then(function(e){var n;if(r.lastRespStatus=e.status,r.isRequestSuccessful())return t=1,e;r.lastError=null!=(n=e.statusText)?n:e})},function(e){r.lastError=e instanceof Error?e.message:e});return Promise.resolve(n&&n.then?n.then(function(e){return t?e:void 0}):t?n:void 0)}catch(e){return Promise.reject(e)}},t.isRequestSuccessful=function(){return this.validStatusCodes.includes(this.lastRespStatus)},t.throwIfFatalError=function(){if(this.fatalErrors.includes(this.lastError))throw new Error("Fatal error encountered: (Status: "+this.lastRespStatus+") "+this.lastError)},t.exponentialBackOffAfterFailedRequest=function(e){try{var t=Math.pow(2,e)*this.initialErrorDelayMS;return console.error("Waiting for "+(t/1e3).toFixed(1)+" seconds before next request..."),Promise.resolve(new Promise(function(e){return setTimeout(e,t)})).then(function(){})}catch(e){return Promise.reject(e)}},t.rateLimitThrottle=function(){try{return console.error("Gateway has returned a "+this.lastRespStatus+" status which means your IP is being rate limited. Pausing for "+60..toFixed(1)+" seconds before trying next request..."),Promise.resolve(new Promise(function(e){return setTimeout(e,6e4)})).then(function(){})}catch(e){return Promise.reject(e)}},e}();o=Symbol.toPrimitive;var P,b=/*#__PURE__*/function(){function e(e){if(this.byteCount=void 0,this.byteCount=e,!Number.isFinite(this.byteCount)||!Number.isInteger(this.byteCount)||this.byteCount<0)throw new Error("Byte count must be a non-negative integer value!")}var t=e.prototype;return t[o]=function(e){return"string"===e&&this.toString(),this.byteCount},t.plus=function(t){return new e(this.byteCount+t.byteCount)},t.minus=function(t){return new e(this.byteCount-t.byteCount)},t.isGreaterThan=function(e){return this.byteCount>e.byteCount},t.isGreaterThanOrEqualTo=function(e){return this.byteCount>=e.byteCount},t.toString=function(){return""+this.byteCount},t.valueOf=function(){return this.byteCount},t.toJSON=function(){return this.byteCount},t.equals=function(e){return this.byteCount===e.byteCount},e}(),F=function(e){return"\n\tedges {\n\t\t"+(e?"":"cursor")+"\n\t\t\n\tnode {\n\t\tid\n\t\ttags {\n\t\t\tname\n\t\t\tvalue\n\t\t}\n\t\t\n\towner {\n\t\taddress\n\t}\n\n\t}\n\n\t}\n"},T=Object.values(ve);"undefined"==typeof Symbol||Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")),P=Symbol.toPrimitive;var D,x,S=/*#__PURE__*/function(){function e(e){if(this.address=void 0,this.address=e,!e.match(new RegExp("^[a-zA-Z0-9_-]{43}$")))throw new Error("Arweave addresses must be 43 characters in length with characters in the following set: [a-zA-Z0-9_-]")}var t=e.prototype;return t[P]=function(e){if("number"===e)throw new Error("Arweave addresses cannot be interpreted as a number!");return this.toString()},t.equals=function(e){return this.address===e.address},t.toString=function(){return this.address},t.valueOf=function(){return this.address},t.toJSON=function(){return this.toString()},e}();function E(e){return new S(e)}var A=/^[a-f\d]{8}-([a-f\d]{4}-){3}[a-f\d]{12}$/i;D=Symbol.toPrimitive;var j=/*#__PURE__*/function(){function e(e){if(this.entityId=void 0,this.entityId=e,!e.match(A)&&"ENCRYPTED"!==e)throw new Error("Invalid entity ID '"+e+"'!'")}var t=e.prototype;return t[D]=function(e){if("number"===e)throw new Error("Entity IDs cannot be interpreted as a number!");return this.toString()},t.toString=function(){return this.entityId},t.valueOf=function(){return this.entityId},t.equals=function(e){return this.entityId===e.entityId},t.toJSON=function(){return this.toString()},e}();function N(e){return new j(e)}x=Symbol.toPrimitive;var C=/*#__PURE__*/function(){function e(e){if(this.unixTime=void 0,this.unixTime=e,this.unixTime<0||!Number.isInteger(this.unixTime)||!Number.isFinite(this.unixTime))throw new Error("Unix time must be a positive integer!")}var t=e.prototype;return t.equals=function(e){return+this.unixTime==+e.unixTime},t[x]=function(e){return"string"===e&&this.toString(),this.unixTime},t.toString=function(){return""+this.unixTime},t.valueOf=function(){return this.unixTime},t.toJSON=function(){return this.unixTime},e}(),q=/*#__PURE__*/function(){function e(e){if(this.keyData=void 0,this.keyData=e,!Buffer.isBuffer(e))throw new Error("The argument must be of type Buffer, got "+typeof e)}var t=e.prototype;return t.toString=function(){return this.keyData.toString("base64").replace("=","")},t.toJSON=function(){return this.toString()},e}(),M=function(e,t,r,n,i,o,a,u,s,c,d){this.appName=void 0,this.appVersion=void 0,this.arFS=void 0,this.contentType=void 0,this.driveId=void 0,this.entityType=void 0,this.name=void 0,this.txId=void 0,this.unixTime=void 0,this.customMetaDataGqlTags=void 0,this.customMetaDataJson=void 0,this.appName=e,this.appVersion=t,this.arFS=r,this.contentType=n,this.driveId=i,this.entityType=o,this.name=a,this.txId=u,this.unixTime=s,this.customMetaDataGqlTags=c,this.customMetaDataJson=d},O=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,h,f,v,p,m,y){var I;return(I=e.call(this,t,r,n,i,o,a,u,c,d,m,y)||this).entityType=void 0,I.size=void 0,I.lastModifiedDate=void 0,I.dataTxId=void 0,I.dataContentType=void 0,I.parentFolderId=void 0,I.entityId=void 0,I.entityType=a,I.size=s,I.lastModifiedDate=l,I.dataTxId=h,I.dataContentType=f,I.parentFolderId=v,I.entityId=p,I}return h(t,e),t}(M),R=/*#__PURE__*/function(){function e(e){var t=e.entityId,r=e.gatewayApi,n=e.owner;this.appName=void 0,this.appVersion=void 0,this.arFS=void 0,this.contentType=void 0,this.driveId=void 0,this.entityType=void 0,this.name=void 0,this.txId=void 0,this.unixTime=void 0,this.entityId=void 0,this.gatewayApi=void 0,this.owner=void 0,this.customMetaData={},this.entityId=t,this.gatewayApi=r,this.owner=n}var t=e.prototype;return t.getDataForTxID=function(e){return this.gatewayApi.getTxData(e)},t.parseFromArweaveNode=function(e,t){try{var r=function(t){return n.txId=E(e.id),e.tags.forEach(function(e){var t=e.value;switch(e.name){case"App-Name":n.appName=t;break;case"App-Version":n.appVersion=t;break;case"ArFS":n.arFS=t;break;case"Content-Type":n.contentType=t;break;case"Drive-Id":n.driveId=N(t);break;case"Entity-Type":n.entityType=t;break;case"Unix-Time":n.unixTime=new C(+t);break;default:i.push(e)}}),i},n=this,i=[],o=function(){if(!e){var r=J({tags:n.getGqlQueryParameters(),owner:t});return Promise.resolve(n.gatewayApi.gqlRequest(r)).then(function(t){var r=t.edges;if(!r.length)throw new Error("Entity with ID "+n.entityId+" not found!");e=r[0].node})}}();return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},t.build=function(e){try{var t=this;return Promise.resolve(t.parseFromArweaveNode(e,t.owner)).then(function(e){return t.parseCustomMetaDataFromGqlTags(e),t.buildEntity()})}catch(e){return Promise.reject(e)}},t.parseCustomMetaDataFromGqlTags=function(e){for(var t,r={},n=p(e);!(t=n()).done;){var i,o=t.value,a=o.name,u=o.value,s=r[a],c=s?Array.isArray(s)?[].concat(s,[u]):[s,u]:u;Object.assign(r,((i={})[a]=c,i))}!function(e){if("object"!=typeof e||null===e)return!1;for(var t=0,r=Object.entries(e);t<r.length;t++){var n=r[t],i=n[0],o=n[1];if(V.protectedArFSGqlTagNames.includes(i))return console.error("Provided custom metadata GQL tag name collides with a protected ArFS protected tag: "+i),!1;if("string"!=typeof o){if(!Array.isArray(o))return!1;for(var a,u=p(o);!(a=u()).done;){var s=a.value;if("string"!=typeof s)return!1;K(s)}}else K(o)}return!0}(r)?console.error("Parsed an invalid custom metadata shape from MetaData Tx GQL Tags: "+r):Object.keys(r).length>0&&(this.customMetaData.metaDataGqlTags=r)},t.parseCustomMetaDataFromDataJson=function(e){var t=this;if(function(e){try{JSON.parse(JSON.stringify(e))}catch(e){return!1}return!0}(e)){for(var r,n={},i=p(Object.entries(e).filter(function(e){return!t.protectedDataJsonKeys.includes(e[0])}));!(r=i()).done;){var o,a=r.value;Object.assign(n,((o={})[a[0]]=a[1],o))}Object.keys(n).length>0&&(this.customMetaData.metaDataJson=n)}else console.error("Parsed an invalid custom metadata shape from MetaData Tx Data JSON: "+e)},e}(),k=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).parentFolderId=void 0,t}return h(t,e),t.prototype.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){return e.forEach(function(e){"Parent-Folder-Id"===e.name?r.parentFolderId=N(e.value):n.push(e)}),n})}catch(e){return Promise.reject(e)}},t}(R),V=/*#__PURE__*/function(){function e(e){var t=e.appName,r=void 0===t?"default":t,n=e.appVersion,i=void 0===n?"default":n,o=e.arFSVersion,a=void 0===o?"default":o;this.appName=void 0,this.appVersion=void 0,this.arFSVersion=void 0,this.appName=r,this.appVersion=i,this.arFSVersion=a}return e.prototype.getFileDataItemTags=function(e,t){var r=this.baseAppTags;return r.push.apply(r,e?[oe,ae,ue]:[{name:"Content-Type",value:t}]),r},d(e,[{key:"baseAppTags",get:function(){return[{name:"App-Name",value:this.appName},{name:"App-Version",value:this.appVersion}]}},{key:"baseArFSTags",get:function(){return[].concat(this.baseAppTags,[{name:"ArFS",value:this.arFSVersion}])}},{key:"baseBundleTags",get:function(){return[].concat(this.baseAppTags,[{name:"Bundle-Format",value:"binary"},{name:"Bundle-Version",value:"2.0.0"}])}}]),e}();V.protectedArFSGqlTagNames=T,l({},{created:[],tips:[],fees:{}},{manifest:{},links:[]});var _=function(e){try{var t,r,n,i,o;t="";var a=e.length;for(r=0;r<a;)switch((n=e[r++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:i=e[r++],t+=String.fromCharCode((31&n)<<6|63&i);break;case 14:i=e[r++],o=e[r++],t+=String.fromCharCode((15&n)<<12|(63&i)<<6|(63&o)<<0)}return Promise.resolve(t)}catch(e){return Promise.reject(e)}};function J(e){var t=e.tags,r=e.cursor,n=e.owner,i=e.sort,o=void 0===i?"HEIGHT_DESC":i,a=e.ids,u="";(void 0===t?[]:t).forEach(function(e){u=u+'\n\t\t\t\t{ name: "'+e.name+'", values: '+(Array.isArray(e.value)?JSON.stringify(e.value):'"'+e.value+'"')+" }"});var s=void 0===r;return{query:"query {\n\t\t\ttransactions(\n\t\t\t\t"+(null!=a&&a.length?"ids: ["+a.map(function(e){return'"'+e+'"'})+"]":"")+"\n\t\t\t\tfirst: "+(s?1:100)+"\n\t\t\t\tsort: "+o+"\n\t\t\t\t"+(s?"":'after: "'+r+'"')+"\n\t\t\t\t"+(void 0===n?"":'owners: ["'+n+'"]')+"\n\t\t\t\ttags: [\n\t\t\t\t\t"+u+"\n\t\t\t\t]\n\t\t\t) {\n\t\t\t\t"+(s?"":"\n\tpageInfo {\n\t\thasNextPage\n\t}\n")+"\n\t\t\t\t"+F(s)+"\n\t\t\t}\n\t\t}"}}function G(e){var t,r,n=null!=(t=e.api.config.protocol)?t:ce,i=null!=(r=e.api.config.host)?r:se;return new URL(n+"://"+i+(e.api.config.port?":"+e.api.config.port:"")+"/")}function K(e){if(0===e.length)throw Error("Metadata string must be at least one character!")}function B(e,t,r){var n=r.filter(function(t){return t.entityId.equals(e.entityId)});return e.txId.equals(n[0].txId)}function U(e,t,r){var n=r.filter(function(t){return t.driveId.equals(e.driveId)});return e.txId.equals(n[0].txId)}var z=/*#__PURE__*/function(){function e(e,t){var r=this;this.dbPromise=void 0,this.cache=new IDBDatabase,this._gatewayApi=void 0,this.dbPromise=this.initDatabase(e),this.initDatabase(e).then(function(e){r.cache=e}),this._gatewayApi=new w({gatewayUrl:G(null!=t?t:s.default.init({}))})}var t=e.prototype;return t.cacheKeyString=function(e){return"string"==typeof e?e:JSON.stringify(e)},t.initDatabase=function(e){try{return Promise.resolve(new Promise(function(e,t){var r=indexedDB.open("arfs-entity-cache-db",1);r.onerror=function(e){t(r.error)},r.onupgradeneeded=function(e){var t=r.result.createObjectStore("cache",{keyPath:"key"});t.createIndex("key","key",{unique:!0}),t.createIndex("value","value")},r.onsuccess=function(t){e(r.result)}}))}catch(e){return Promise.reject(e)}},t.put=function(e,t){try{var r=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(n,i){var o=e.transaction("cache","readwrite").objectStore("cache").put({key:r,value:t});o.onsuccess=function(e){n(t)},o.onerror=function(e){i(o.error)}})})}catch(e){return Promise.reject(e)}},t.get=function(e){try{var t=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(r,n){var i=e.transaction("cache","readonly").objectStore("cache").index("key").get(t);i.onsuccess=function(e){var t=i.result;r(t?t.value:void 0)},i.onerror=function(e){n(i.error)}})})}catch(e){return Promise.reject(e)}},t.remove=function(e){try{var t=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(r,n){var i=e.transaction("cache","readwrite").objectStore("cache"),o=i.index("key").getKey(t);o.onsuccess=function(e){var t=o.result;if(void 0!==t){var a=i.delete(t);a.onsuccess=function(){r()},a.onerror=function(){n(a.error)}}else r()},o.onerror=function(e){n(o.error)}})})}catch(e){return Promise.reject(e)}},t.clear=function(){try{return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(t,r){var n=e.transaction("cache","readwrite").objectStore("cache").clear();n.onsuccess=function(e){t()},n.onerror=function(e){r(n.error)}})})}catch(e){return Promise.reject(e)}},t.size=function(){try{return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(t,r){var n=e.transaction("cache","readonly").objectStore("cache").count();n.onsuccess=function(e){t(n.result)},n.onerror=function(e){r(n.error)}})})}catch(e){return Promise.reject(e)}},e}(),L=/*#__PURE__*/function(){function e(){}return e.platformCacheFolder=function(){return"metadata"},e.initDatabase=function(){try{return Promise.resolve(new Promise(function(e,t){var r=indexedDB.open("arfs-metadata-cache-db",1);r.onerror=function(e){t(r.error)},r.onupgradeneeded=function(e){var t=r.result.createObjectStore("cache",{keyPath:"txId"});t.createIndex("txId","txId",{unique:!0}),t.createIndex("buffer","buffer")},r.onsuccess=function(t){e(r.result)}}))}catch(e){return Promise.reject(e)}},e.getCacheFolder=function(){try{var e=this;return e.cacheFolderPromise||(e.cacheFolderPromise=new Promise(function(t){t(e.metadataCacheFolder)})),Promise.resolve(e.cacheFolderPromise)}catch(e){return Promise.reject(e)}},e.put=function(e,t){try{return Promise.resolve(this.getDatabase()).then(function(r){return new Promise(function(n,i){var o=r.transaction("cache","readwrite").objectStore("cache").put({txId:e,buffer:t});o.onsuccess=function(e){n()},o.onerror=function(e){i(o.error)}})})}catch(e){return Promise.reject(e)}},e.get=function(e){try{return Promise.resolve(this.getDatabase()).then(function(t){return new Promise(function(r,n){var i=t.transaction("cache","readonly").objectStore("cache").index("txId").get(e.toString());i.onsuccess=function(e){var t=i.result;r(t?t.buffer:void 0)},i.onerror=function(e){n(i.error)}})})}catch(e){return Promise.reject(e)}},e.getDatabase=function(){try{var e=this;return e.dbPromise||(e.dbPromise=e.initDatabase()),Promise.resolve(e.dbPromise)}catch(e){return Promise.reject(e)}},e}();L.cacheFolderPromise=void 0,L.shouldCacheLog="1"===process.env.ARDRIVE_CACHE_LOG,L.metadataCacheFolder=L.platformCacheFolder(),L.logTag="[Metadata Cache] ",L.dbPromise=void 0;var Q={ownerCache:new z(10),driveIdCache:new z(10),publicDriveCache:new z(10),publicFolderCache:new z(10),publicFileCache:new z(10)},H=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,h,f,v,p,m){var y;return(y=e.call(this,t,r,n,i,o,"file",a,l,u,s,h,f,v,c,d,p,m)||this).fileId=void 0,y.fileId=d,y}return h(t,e),t}(O),W=/*#__PURE__*/function(e){function t(t,r){var n;return(n=e.call(this,t.appName,t.appVersion,t.arFS,t.contentType,t.driveId,t.name,t.txId,t.unixTime,t.parentFolderId,t.fileId,t.size,t.lastModifiedDate,t.dataTxId,t.dataContentType,t.customMetaDataGqlTags,t.customMetaDataJson)||this).path=void 0,n.txIdPath=void 0,n.entityIdPath=void 0,n.path=""+r.pathToFolderId(t.parentFolderId)+t.name,n.txIdPath=""+r.txPathToFolderId(t.parentFolderId)+t.txId,n.entityIdPath=""+r.entityPathToFolderId(t.parentFolderId)+t.fileId,n}return h(t,e),t}(H),$=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return h(t,e),t.fromArweaveNode=function(e,r){var n,i=null==(n=e.tags.find(function(e){return"File-Id"===e.name}))?void 0:n.value;if(!i)throw new Error("File-ID tag missing!");return new t({entityId:N(i),gatewayApi:r})},t.prototype.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid file state")},r=this,n=function(){var t,n,i,o,a;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.parentFolderId&&r.entityId)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(_(t)).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){var n;if(r.name=t.name,r.size=new b(t.size),r.lastModifiedDate=new C(t.lastModifiedDate),r.dataTxId=new S(t.dataTxId),r.dataContentType=null!=(n=t.dataContentType)?n:function(e){var t=e.substring(e.lastIndexOf(".")+1);t=t.toLowerCase();var r=u.lookup(t);return!1===r?"unknown":r}(r.name),!(r.name&&void 0!==r.size&&r.lastModifiedDate&&r.dataTxId&&r.dataContentType&&"file"===r.entityType))throw new Error("Invalid file state");r.parseCustomMetaDataFromDataJson(t);var i=Promise.resolve(new H(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.name,r.txId,r.unixTime,r.parentFolderId,r.entityId,r.size,r.lastModifiedDate,r.dataTxId,r.dataContentType,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson));return e=1,i})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).size=void 0,t.lastModifiedDate=void 0,t.dataTxId=void 0,t.dataContentType=void 0,t.protectedDataJsonKeys=["name","size","lastModifiedDate","dataTxId","dataContentType"],t}h(t,e);var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"File-Id",value:""+this.entityId},{name:"Entity-Type",value:"file"}]},r.parseFromArweaveNode=function(t){try{return Promise.resolve(e.prototype.parseFromArweaveNode.call(this,t)).then(function(e){return e.filter(function(e){return"File-Id"!==e.name})})}catch(e){return Promise.reject(e)}},t}(k));new b(2147483646);var Y=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,h){var f;return(f=e.call(this,t,r,n,i,o,"folder",a,new b(0),u,s,new C(0),pe,ie,c,d,l,h)||this).folderId=void 0,f.folderId=d,f}return h(t,e),t}(O),Z=/*#__PURE__*/function(e){function t(t,r){var n;return(n=e.call(this,t.appName,t.appVersion,t.arFS,t.contentType,t.driveId,t.name,t.txId,t.unixTime,t.parentFolderId,t.folderId,t.customMetaDataGqlTags,t.customMetaDataJson)||this).path=void 0,n.txIdPath=void 0,n.entityIdPath=void 0,n.path=""+r.pathToFolderId(t.parentFolderId)+t.name,n.txIdPath=""+r.txPathToFolderId(t.parentFolderId)+t.txId,n.entityIdPath=""+r.entityPathToFolderId(t.parentFolderId)+t.folderId,n}return h(t,e),t}(Y),X=/*#__PURE__*/function(){function e(e,t,r){void 0===r&&(r=[]),this.folderId=void 0,this.parent=void 0,this.children=void 0,this.folderId=e,this.parent=t,this.children=r}return e.fromEntity=function(t){return new e(t.entityId)},e}(),ee=/*#__PURE__*/function(){function e(e,t){this.folderIdToEntityMap=void 0,this.folderIdToNodeMap=void 0,this._rootNode=void 0,this.folderIdToEntityMap=e,this.folderIdToNodeMap=t}e.newFromEntities=function(t){for(var r,n=t.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.entityId]=t,r))},{}),i={},o=p(t);!(r=o()).done;)this.setupNodesWithEntity(r.value,n,i);return new e(n,i)},e.setupNodesWithEntity=function(e,t,r){var n=Object.keys(r).includes(""+e.entityId),i=Object.keys(r).includes(""+e.parentFolderId);if(!n){if(!i){var o=t[""+e.parentFolderId];o&&this.setupNodesWithEntity(o,t,r)}var a=r[""+e.parentFolderId];if(a){var u=new X(e.entityId,a);a.children.push(u),r[""+e.entityId]=u}else{var s=new X(e.entityId);r[""+e.entityId]=s}}};var t=e.prototype;return t.subTreeOf=function(t,r){var n=this;void 0===r&&(r=Number.MAX_SAFE_INTEGER);var i=this.nodeAndChildrenOf(this.folderIdToNodeMap[""+t],r);return new e(i.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.folderId]=n.folderIdToEntityMap[""+t.folderId],r))},{}),i.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.folderId]=t,r))},{}))},t.allFolderIDs=function(){return Object.keys(this.folderIdToEntityMap).map(function(e){return N(e)})},t.nodeAndChildrenOf=function(e,t){var r=this,n=[e];return t>0&&e.children.forEach(function(e){n.push.apply(n,r.nodeAndChildrenOf(e,t-1))}),n},t.folderIdSubtreeFromFolderId=function(e,t){var r=this,n=this.folderIdToNodeMap[""+e],i=[n.folderId];return 0===t||n.children.map(function(e){return e.folderId}).forEach(function(e){i.push.apply(i,r.folderIdSubtreeFromFolderId(e,t-1))}),i},t.pathToFolderId=function(e){var t=this;if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===de)return"/";for(var r=this.folderIdToNodeMap[""+e],n=[r];r.parent&&!r.folderId.equals(this.rootNode.folderId);)n.push(r=r.parent);return"/"+n.reverse().map(function(e){return t.folderIdToEntityMap[""+e.folderId].name}).join("/")+"/"},t.entityPathToFolderId=function(e){if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===de)return"/";for(var t=this.folderIdToNodeMap[""+e],r=[t];t.parent&&!t.folderId.equals(this.rootNode.folderId);)r.push(t=t.parent);return"/"+r.reverse().map(function(e){return e.folderId}).join("/")+"/"},t.txPathToFolderId=function(e){var t=this;if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===de)return"/";for(var r=this.folderIdToNodeMap[""+e],n=[r];r.parent&&!r.folderId.equals(this.rootNode.folderId);)n.push(r=r.parent);return"/"+n.reverse().map(function(e){return t.folderIdToEntityMap[""+e.folderId].txId}).join("/")+"/"},d(e,[{key:"rootNode",get:function(){if(this._rootNode)return this._rootNode;for(var e=Object.keys(this.folderIdToEntityMap)[0],t=this.folderIdToNodeMap[e];t.parent&&this.folderIdToNodeMap[""+t.parent.folderId];)t=t.parent;return this._rootNode=t,t}}]),e}(),te=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).protectedDataJsonKeys=["name"],t}h(t,e);var r=t.prototype;return r.parseFromArweaveNode=function(t){try{return Promise.resolve(e.prototype.parseFromArweaveNode.call(this,t)).then(function(e){return e.filter(function(e){return"Folder-Id"!==e.name})})}catch(e){return Promise.reject(e)}},r.getGqlQueryParameters=function(){return[{name:"Folder-Id",value:""+this.entityId},{name:"Entity-Type",value:"folder"}]},t}(k),re=/*#__PURE__*/function(e){function t(){var t;return(t=e.call(this,""+me)||this).entityId=de,t}return h(t,e),t}(j),ne=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return h(t,e),t.fromArweaveNode=function(e,r){var n,i=null==(n=e.tags.find(function(e){return"Folder-Id"===e.name}))?void 0:n.value;if(!i)throw new Error("Folder-ID tag missing!");return new t({entityId:N(i),gatewayApi:r})},t.prototype.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid public folder state")},r=this;r.parentFolderId||(r.parentFolderId=new re);var n=function(){var t,n,i,o,a;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.parentFolderId&&r.entityId&&"folder"===r.entityType)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(_(t)).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){if(r.name=t.name,!r.name)throw new Error("Invalid public folder state: name not found!");r.parseCustomMetaDataFromDataJson(t);var n=Promise.resolve(new Y(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.name,r.txId,r.unixTime,r.parentFolderId,r.entityId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson));return e=1,n})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(te),ie="application/json",oe={name:"Content-Type",value:"application/octet-stream"},ae={name:"Cipher",value:"AES256-GCM"},ue={name:"Cipher-IV",value:"qwertyuiopasdfgh"},se="arweave.net",ce="https",de="root folder",le="ENCRYPTED",he=500,fe=["invalid_json","chunk_too_big","data_path_too_big","offset_too_big","data_size_too_big","chunk_proof_ratio_not_attractive","invalid_proof"],ve={arFS:"ArFS",tipType:"Tip-Type",contentType:"Content-Type",boost:"Boost",bundleFormat:"Bundle-Format",bundleVersion:"Bundle-Version",entityType:"Entity-Type",unitTime:"Unix-Time",driveId:"Drive-Id",folderId:"Folder-Id",fileId:"File-Id",parentFolderId:"Parent-Folder-Id",drivePrivacy:"Drive-Privacy",cipher:"Cipher",cipherIv:"Cipher-IV",driveAuthMode:"Drive-Auth-Mode"},pe=new S("0000000000000000000000000000000000000000000"),me=N("00000000-0000-0000-0000-000000000000"),ye=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,h,f){var v;return(v=e.call(this,t,r,n,i,o,a,u,s,c,h,f)||this).appName=void 0,v.appVersion=void 0,v.arFS=void 0,v.contentType=void 0,v.driveId=void 0,v.entityType=void 0,v.name=void 0,v.txId=void 0,v.unixTime=void 0,v.drivePrivacy=void 0,v.rootFolderId=void 0,v.appName=t,v.appVersion=r,v.arFS=n,v.contentType=i,v.driveId=o,v.entityType=a,v.name=u,v.txId=s,v.unixTime=c,v.drivePrivacy=d,v.rootFolderId=l,v}return h(t,e),t}(M),Ie=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,h,f,v,p,m,y){var I;return(I=e.call(this,t,r,n,i,o,a,u,s,c,m,y)||this).appName=void 0,I.appVersion=void 0,I.arFS=void 0,I.contentType=void 0,I.driveId=void 0,I.entityType=void 0,I.name=void 0,I.txId=void 0,I.unixTime=void 0,I.drivePrivacy=void 0,I.rootFolderId=void 0,I.driveAuthMode=void 0,I.cipher=void 0,I.cipherIV=void 0,I.driveKey=void 0,I.appName=t,I.appVersion=r,I.arFS=n,I.contentType=i,I.driveId=o,I.entityType=a,I.name=u,I.txId=s,I.unixTime=c,I.drivePrivacy=d,I.rootFolderId=l,I.driveAuthMode=h,I.cipher=f,I.cipherIV=v,I.driveKey=p,I}return h(t,e),t}(M),ge=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).protectedDataJsonKeys=["name","rootFolderId"],t}return h(t,e),t}(R),we=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).drivePrivacy=void 0,t.rootFolderId=void 0,t}h(t,e),t.fromArweaveNode=function(e,r){var n,i=null==(n=e.tags.find(function(e){return"Drive-Id"===e.name}))?void 0:n.value;if(!i)throw new Error("Drive-ID tag missing!");return new t({entityId:N(i),gatewayApi:r})};var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"Drive-Id",value:""+this.entityId},{name:"Entity-Type",value:"drive"},{name:"Drive-Privacy",value:"public"}]},r.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){return e.forEach(function(e){"Drive-Privacy"===e.name?r.drivePrivacy=e.value:n.push(e)}),n})}catch(e){return Promise.reject(e)}},r.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid drive state")},r=this,n=function(){var t,n,i,o,a,u;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.driveId.equals(r.entityId)&&null!=(u=r.drivePrivacy)&&u.length)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(_(t)).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){if(r.name=t.name,r.rootFolderId=t.rootFolderId,!r.name||!r.rootFolderId)throw new Error("Invalid drive state");r.parseCustomMetaDataFromDataJson(t);var n=new ye(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,n})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(ge),Pe=/*#__PURE__*/function(e){function t(t){var r,n=t.privateKeyData;return(r=e.call(this,{entityId:t.entityId,gatewayApi:t.gatewayApi})||this).drivePrivacy=void 0,r.rootFolderId=void 0,r.driveAuthMode=void 0,r.cipher=void 0,r.cipherIV=void 0,r.privateKeyData=void 0,r.privateKeyData=n,r}h(t,e);var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"Drive-Id",value:""+this.entityId},{name:"Entity-Type",value:"drive"}]},t.fromArweaveNode=function(e,r,n){var i,o=null==(i=e.tags.find(function(e){return"Drive-Id"===e.name}))?void 0:i.value;if(!o)throw new Error("Drive-ID tag missing!");return new t({entityId:N(o),privateKeyData:n,gatewayApi:r})},r.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){return e.forEach(function(e){var t=e.value;switch(e.name){case"Cipher":r.cipher=t;break;case"Cipher-IV":r.cipherIV=t;break;case"Drive-Auth-Mode":r.driveAuthMode=t;break;case"Drive-Privacy":r.drivePrivacy=t;break;default:n.push(e)}}),n})}catch(e){return Promise.reject(e)}},r.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid drive state")},r=this,n=function(){var t,n,i,o,a,u;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&null!=(u=r.drivePrivacy)&&u.length){var s="private"===r.drivePrivacy;return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){var n=Buffer.from(t);return Promise.resolve(function(){try{if(s){var e,i,o;if(null!=(e=r.cipher)&&e.length&&null!=(i=r.driveAuthMode)&&i.length&&null!=(o=r.cipherIV)&&o.length)return Promise.resolve(r.privateKeyData.safelyDecryptToJson(r.cipherIV,r.entityId,n,{name:le,rootFolderId:le}));throw new Error("Invalid private drive state")}return Promise.resolve(_(t)).then(JSON.parse)}catch(e){return Promise.reject(e)}}()).then(function(t){if(r.name=t.name,r.rootFolderId=N(t.rootFolderId),r.parseCustomMetaDataFromDataJson(t),s){if(!r.driveAuthMode||!r.cipher||!r.cipherIV)throw new Error("Unexpectedly null privacy data for private drive with ID "+r.driveId+"!");var n=new be(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.driveAuthMode,r.cipher,r.cipherIV,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,n}var i=new ye(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,i})})}}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(ge),be=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,h,f,v,p,m){var y;return(y=e.call(this,t,r,n,i,o,a,u,s,c,d,l,h,f,v,new q(Buffer.from([])),p,m)||this).driveKey=void 0,y.driveKey=new q(Buffer.from([])),delete y.driveKey,y}return h(t,e),t}(Ie);function Fe(e,t,r){if(!e.s){if(r instanceof Te){if(!r.s)return void(r.o=Fe.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(Fe.bind(null,e,t),Fe.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}var Te=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{Fe(n,1,o(this.v))}catch(e){Fe(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?Fe(n,1,t?t(i):i):r?Fe(n,1,r(i)):Fe(n,2,i)}catch(e){Fe(n,2,e)}},n},e}();function De(e){return e instanceof Te&&1&e.s}function xe(e,t,r){for(var n;;){var i=e();if(De(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!De(o)){n=1;break}o=o.s}if(t){var a=t();if(a&&a.then&&!De(a)){n=2;break}}}var u=new Te,s=Fe.bind(null,u,2);return(0===n?i.then(d):1===n?o.then(c):a.then(l)).then(void 0,s),u;function c(n){o=n;do{if(t&&(a=t())&&a.then&&!De(a))return void a.then(l).then(void 0,s);if(!(i=e())||De(i)&&!i.v)return void Fe(u,1,o);if(i.then)return void i.then(d).then(void 0,s);De(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,s)}function d(e){e?(o=r())&&o.then?o.then(c).then(void 0,s):c(o):Fe(u,1,o)}function l(){(i=e())?i.then?i.then(d).then(void 0,s):d(i):Fe(u,1,o)}}var Se="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";exports.ArFSClient=/*#__PURE__*/function(){function e(e,t,r){void 0===t&&(t=Q),void 0===r&&(r=new w({gatewayUrl:G(e)})),this.caches=void 0,this.gatewayApi=void 0,this._arweave=void 0,this._gatewayApi=void 0,this._caches=void 0,this.appName=void 0,this.appVersion=void 0,this.caches=t,this.gatewayApi=r,this._arweave=e,this._gatewayApi=r,this._caches=t,this.appName="ArFS",this.appVersion="0.0.1"}var t=e.prototype;return t.getOwnerForDriveId=function(e){try{var t=this;return Promise.resolve(t.caches.ownerCache.get(e)).then(function(r){return r||t.caches.ownerCache.put(e,function(){try{var r=J({tags:[{name:"Drive-Id",value:""+e},{name:"Entity-Type",value:"drive"}],sort:"HEIGHT_ASC"});return Promise.resolve(t.gatewayApi.gqlRequest(r)).then(function(t){var r=t.edges;if(!r.length)throw new Error('Could not find a transaction with "Drive-Id": '+e);return E(r[0].node.owner.address)})}catch(e){return Promise.reject(e)}}())})}catch(e){return Promise.reject(e)}},t.getDriveIDForEntityId=function(e,t){try{var r=this;return Promise.resolve(r.caches.driveIdCache.get(e)).then(function(n){return n||r.caches.driveIdCache.put(e,function(){try{var n=J({tags:[{name:t,value:""+e}]});return Promise.resolve(r.gatewayApi.gqlRequest(n)).then(function(r){var n=r.edges;if(!n.length)throw new Error("Entity with "+t+" "+e+" not found!");var i=n[0].node.tags.find(function(e){return"Drive-Id"===e.name});if(i)return N(i.value);throw new Error("No Drive-Id tag found for meta data transaction of "+t+": "+e)})}catch(e){return Promise.reject(e)}}())})}catch(e){return Promise.reject(e)}},t.getDriveOwnerForFolderId=function(e){try{var t=this,r=t.getOwnerForDriveId;return Promise.resolve(t.getDriveIdForFolderId(e)).then(function(e){return r.call(t,e)})}catch(e){return Promise.reject(e)}},t.getDriveIdForFolderId=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"Folder-Id"))}catch(e){return Promise.reject(e)}},t.getDriveOwnerForFileId=function(e){try{var t=this,r=t.getOwnerForDriveId;return Promise.resolve(t.getDriveIdForFileId(e)).then(function(e){return r.call(t,e)})}catch(e){return Promise.reject(e)}},t.getDriveIdForFileId=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"File-Id"))}catch(e){return Promise.reject(e)}},t.getDriveIdForEntityID=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"Folder-Id"))}catch(e){return Promise.reject(e)}},t.getPublicDrive=function(e){var t=e.driveId,r=e.owner;try{var n=this,i={driveId:t,owner:r};return Promise.resolve(n.caches.publicDriveCache.get(i)).then(function(e){return e||Promise.resolve(n.caches.publicDriveCache.put(i,new we({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()))})}catch(e){return Promise.reject(e)}},t.getPublicFolder=function(e){var t=e.folderId,r=e.owner;try{var n=this,i={folderId:t,owner:r};return Promise.resolve(n.caches.publicFolderCache.get(i)).then(function(e){return e||Promise.resolve(n.caches.publicFolderCache.put(i,new ne({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()))})}catch(e){return Promise.reject(e)}},t.getPublicFile=function(e){var t=e.fileId,r=e.owner;try{var n=this,i={fileId:t,owner:r};return Promise.resolve(n.caches.publicFileCache.get(i)).then(function(e){return e||Promise.resolve(n.caches.publicFileCache.put(i,new $({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()))})}catch(e){return Promise.reject(e)}},t.getAllDrivesForAddress=function(e){var t=e.address,r=e.privateKeyData,n=e.latestRevisionsOnly,i=void 0===n||n;try{var o=function(){return i?c.filter(U):c},a=this,u="",s=!0,c=[],d=xe(function(){return!!s},void 0,function(){var e=J({tags:[{name:"Entity-Type",value:"drive"}],cursor:u,owner:t});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){s=e.pageInfo.hasNextPage;var n=e.edges.map(function(e){try{var n=e.node;u=e.cursor;var i=Pe.fromArweaveNode(n,a.gatewayApi,r);return Promise.resolve(i.build(n)).then(function(e){return"public"===e.drivePrivacy?a.caches.publicDriveCache.put({driveId:e.driveId,owner:t},Promise.resolve(e)):Promise.resolve(e)})}catch(e){return Promise.reject(e)}}),i=c.push;return Promise.resolve(Promise.all(n)).then(function(e){i.call.apply(i,[c].concat(e))})})});return Promise.resolve(d&&d.then?d.then(o):o())}catch(e){return Promise.reject(e)}},t.getPublicFilesWithParentFolderIds=function(e,t,r){void 0===r&&(r=!1);try{var n=function(){return r?u.filter(B):u},i=this,o="",a=!0,u=[],s=xe(function(){return!!a},void 0,function(){var r=J({tags:[{name:"Parent-Folder-Id",value:e.map(function(e){return e.toString()})},{name:"Entity-Type",value:"file"}],cursor:o,owner:t});return Promise.resolve(i.gatewayApi.gqlRequest(r)).then(function(e){a=e.pageInfo.hasNextPage;var r=e.edges.map(function(e){try{var r=e.node;o=e.cursor;var n=$.fromArweaveNode(r,i.gatewayApi);return Promise.resolve(n.build(r)).then(function(e){var r={fileId:e.fileId,owner:t};return u.push(e),i.caches.publicFileCache.put(r,Promise.resolve(e))})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(r)).then(function(){})})});return Promise.resolve(s&&s.then?s.then(n):n())}catch(e){return Promise.reject(e)}},t.getAllFoldersOfPublicDrive=function(e){var t=e.driveId,r=e.owner,n=e.latestRevisionsOnly,i=void 0!==n&&n;try{var o=function(){return i?c.filter(B):c},a=this,u="",s=!0,c=[],d=xe(function(){return!!s},void 0,function(){var e=J({tags:[{name:"Drive-Id",value:""+t},{name:"Entity-Type",value:"folder"}],cursor:u,owner:r});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){s=e.pageInfo.hasNextPage;var t=e.edges.map(function(e){try{var t=e.node;u=e.cursor;var n=ne.fromArweaveNode(t,a.gatewayApi);return Promise.resolve(n.build(t)).then(function(e){return a.caches.publicFolderCache.put({folderId:e.entityId,owner:r},Promise.resolve(e))})}catch(e){return Promise.reject(e)}}),n=c.push;return Promise.resolve(Promise.all(t)).then(function(e){n.call.apply(n,[c].concat(e))})})});return Promise.resolve(d&&d.then?d.then(o):o())}catch(e){return Promise.reject(e)}},t.listPublicFolder=function(e){var t=e.folderId,r=e.maxDepth,n=e.includeRoot,i=e.owner;try{var o=this;if(!Number.isInteger(r)||r<0)throw new Error("maxDepth should be a non-negative integer!");return Promise.resolve(o.getPublicFolder({folderId:t,owner:i})).then(function(e){return Promise.resolve(o.getAllFoldersOfPublicDrive({driveId:e.driveId,owner:i,latestRevisionsOnly:!0})).then(function(a){function u(){for(var e,t=[],r=p(l);!(e=r()).done;)t.push(e.value);for(var n,i=p(h);!(n=i()).done;)t.push(n.value);var o=t.map(function(e){return function(e,t){return"folder"===e.entityType?new Z(e,t):new W(e,t)}(e,s)});return o}var s=ee.newFromEntities(a),c=s.folderIdSubtreeFromFolderId(t,r),d=s.folderIdSubtreeFromFolderId(t,r+1).slice(1),l=a.filter(function(e){return d.some(function(t){return t.equals(e.entityId)})});n&&l.unshift(e);var h=[],f=function(e,t,r){if("function"==typeof e[Se]){var n,i,o,a=e[Se]();if(function e(r){try{for(;!(n=a.next()).done;)if((r=t(n.value))&&r.then){if(!De(r))return void r.then(e,o||(o=Fe.bind(null,i=new Te,2)));r=r.v}i?Fe(i,1,r):i=r}catch(e){Fe(i||(i=new Te),2,e)}}(),a.return){var u=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(u,function(e){throw u(e)});u()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var s=[],c=0;c<e.length;c++)s.push(e[c]);return function(e,t,r){var n,i,o=-1;return function r(a){try{for(;++o<e.length;)if((a=t(o))&&a.then){if(!De(a))return void a.then(r,i||(i=Fe.bind(null,n=new Te,2)));a=a.v}n?Fe(n,1,a):n=a}catch(e){Fe(n||(n=new Te),2,e)}}(),n}(s,function(e){return t(s[e])})}(c,function(e){return Promise.resolve(o.getPublicFilesWithParentFolderIds([e],i,!0)).then(function(e){e.forEach(function(e){h.push(e)})})});return f&&f.then?f.then(u):u()})})}catch(e){return Promise.reject(e)}},e}();
