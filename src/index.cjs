var e=require("uuid"),t=require("axios"),r=require("crypto"),n=require("futoin-hkdf"),i=require("utf8"),o=require("jwk-to-pem");require("base64-js");var a=require("mime-types");require("bignumber.js");var u=require("arweave");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var d,l=/*#__PURE__*/s(t),f=/*#__PURE__*/c(r),h=/*#__PURE__*/s(n),v=/*#__PURE__*/s(i),p=/*#__PURE__*/s(o),y=/*#__PURE__*/c(a),m=/*#__PURE__*/s(u);function g(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,"symbol"==typeof(i=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(n.key))?i:String(i),n)}var i}function I(e,t,r){return t&&g(e.prototype,t),r&&g(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},w.apply(this,arguments)}function P(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,b(e,t)}function b(e,t){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},b(e,t)}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function F(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return T(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?T(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function D(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function x(e,t,r){if(!e.s){if(r instanceof S){if(!r.s)return void(r.o=x.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(x.bind(null,e,t),x.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var S=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{x(n,1,o(this.v))}catch(e){x(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?x(n,1,t?t(i):i):r?x(n,1,r(i)):x(n,2,i)}catch(e){x(n,2,e)}},n},e}();function E(e){return e instanceof S&&1&e.s}var A=/*#__PURE__*/function(){function e(e){var t=e.gatewayUrl,r=e.maxRetriesPerRequest,n=void 0===r?8:r,i=e.initialErrorDelayMS,o=void 0===i?Ee:i,a=e.fatalErrors,u=void 0===a?Ae:a,s=e.validStatusCodes,c=void 0===s?[200]:s,d=e.axiosInstance,f=void 0===d?l.default.create({validateStatus:void 0}):d;this.gatewayUrl=void 0,this.maxRetriesPerRequest=void 0,this.initialErrorDelayMS=void 0,this.fatalErrors=void 0,this.validStatusCodes=void 0,this.axiosInstance=void 0,this.lastError="unknown error",this.lastRespStatus=0,this.gatewayUrl=t,this.maxRetriesPerRequest=n,this.initialErrorDelayMS=o,this.fatalErrors=u,this.validStatusCodes=c,this.axiosInstance=f}var t=e.prototype;return t.postChunk=function(e){try{return Promise.resolve(this.postToEndpoint("chunk",e)).then(function(){})}catch(e){return Promise.reject(e)}},t.postTxHeader=function(e){try{return Promise.resolve(this.postToEndpoint("tx",e)).then(function(){})}catch(e){return Promise.reject(e)}},t.gqlRequest=function(e){try{var t=this;return Promise.resolve(D(function(){return Promise.resolve(t.postToEndpoint("graphql",e)).then(function(e){return e.data.data.transactions})},function(e){throw Error("GQL Error: "+e.message)}))}catch(e){return Promise.reject(e)}},t.postToEndpoint=function(e,t){try{var r=this;return Promise.resolve(r.retryRequestUntilMaxRetries(function(){return r.axiosInstance.post(""+r.gatewayUrl.href+e,t)}))}catch(e){return Promise.reject(e)}},t.getTransaction=function(e){try{var t=this;return Promise.resolve(D(function(){return Promise.resolve(t.retryRequestUntilMaxRetries(function(){return t.axiosInstance.get(t.gatewayUrl.href+"tx/"+e)})).then(function(e){return e.data})},function(){throw Error("Transaction could not be found from the gateway: (Status: "+t.lastRespStatus+") "+t.lastError)}))}catch(e){return Promise.reject(e)}},t.getTxData=function(e){try{var t=this;return Promise.resolve(ue.get(e)).then(function(r){return r||Promise.resolve(t.retryRequestUntilMaxRetries(function(){return t.axiosInstance.get(""+t.gatewayUrl.href+e,{responseType:"arraybuffer"})})).then(function(t){var r=t.data;return Promise.resolve(ue.put(e,r)).then(function(){return r})})})}catch(e){return Promise.reject(e)}},t.retryRequestUntilMaxRetries=function(e){try{var t,r=function(e){if(t)return e;throw new Error("Request to gateway has failed: (Status: "+n.lastRespStatus+") "+n.lastError)},n=this,i=0,o=function(e,t,r){for(var n;;){var i=e();if(E(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!E(o)){n=1;break}o=o.s}if(t){var a=t();if(a&&a.then&&!E(a)){n=2;break}}}var u=new S,s=x.bind(null,u,2);return(0===n?i.then(d):1===n?o.then(c):a.then(l)).then(void 0,s),u;function c(n){o=n;do{if(t&&(a=t())&&a.then&&!E(a))return void a.then(l).then(void 0,s);if(!(i=e())||E(i)&&!i.v)return void x(u,1,o);if(i.then)return void i.then(d).then(void 0,s);E(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,s)}function d(e){e?(o=r())&&o.then?o.then(c).then(void 0,s):c(o):x(u,1,o)}function l(){(i=e())?i.then?i.then(d).then(void 0,s):d(i):x(u,1,o)}}(function(){return!t&&i<=n.maxRetriesPerRequest},void 0,function(){return Promise.resolve(n.tryRequest(e)).then(function(e){function r(){function e(){i=t}console.error("Request to gateway has failed: (Status: "+n.lastRespStatus+") "+n.lastError);var t=i+1,r=function(){if(t<=n.maxRetriesPerRequest)return Promise.resolve(n.exponentialBackOffAfterFailedRequest(i)).then(function(){console.error("Retrying request, retry attempt "+t+"...")})}();return r&&r.then?r.then(e):e()}if(e)return i>0&&console.error("Request has been successfully retried!"),t=1,e;n.throwIfFatalError();var o=function(){if(429===n.lastRespStatus)return Promise.resolve(n.rateLimitThrottle()).then(function(){})}();return o&&o.then?o.then(r):r()})});return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(e){return Promise.reject(e)}},t.tryRequest=function(e){try{var t,r=this,n=D(function(){return Promise.resolve(e()).then(function(e){var n;if(r.lastRespStatus=e.status,r.isRequestSuccessful())return t=1,e;r.lastError=null!=(n=e.statusText)?n:e})},function(e){r.lastError=e instanceof Error?e.message:e});return Promise.resolve(n&&n.then?n.then(function(e){return t?e:void 0}):t?n:void 0)}catch(e){return Promise.reject(e)}},t.isRequestSuccessful=function(){return this.validStatusCodes.includes(this.lastRespStatus)},t.throwIfFatalError=function(){if(this.fatalErrors.includes(this.lastError))throw new Error("Fatal error encountered: (Status: "+this.lastRespStatus+") "+this.lastError)},t.exponentialBackOffAfterFailedRequest=function(e){try{var t=Math.pow(2,e)*this.initialErrorDelayMS;return console.error("Waiting for "+(t/1e3).toFixed(1)+" seconds before next request..."),Promise.resolve(new Promise(function(e){return setTimeout(e,t)})).then(function(){})}catch(e){return Promise.reject(e)}},t.rateLimitThrottle=function(){try{return console.error("Gateway has returned a "+this.lastRespStatus+" status which means your IP is being rate limited. Pausing for "+60..toFixed(1)+" seconds before trying next request..."),Promise.resolve(new Promise(function(e){return setTimeout(e,6e4)})).then(function(){})}catch(e){return Promise.reject(e)}},e}();d=Symbol.toPrimitive;var j,C=/*#__PURE__*/function(){function e(e){if(this.byteCount=void 0,this.byteCount=e,!Number.isFinite(this.byteCount)||!Number.isInteger(this.byteCount)||this.byteCount<0)throw new Error("Byte count must be a non-negative integer value!")}var t=e.prototype;return t[d]=function(e){return"string"===e&&this.toString(),this.byteCount},t.plus=function(t){return new e(this.byteCount+t.byteCount)},t.minus=function(t){return new e(this.byteCount-t.byteCount)},t.isGreaterThan=function(e){return this.byteCount>e.byteCount},t.isGreaterThanOrEqualTo=function(e){return this.byteCount>=e.byteCount},t.toString=function(){return""+this.byteCount},t.valueOf=function(){return this.byteCount},t.toJSON=function(){return this.byteCount},t.equals=function(e){return this.byteCount===e.byteCount},e}(),N=function(e){return"\n\tedges {\n\t\t"+(e?"":"cursor")+"\n\t\t\n\tnode {\n\t\tid\n\t\ttags {\n\t\t\tname\n\t\t\tvalue\n\t\t}\n\t\t\n\towner {\n\t\taddress\n\t}\n\n\t}\n\n\t}\n"},q=je?Object.values(je):[];function M(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}const O="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function k(e,t,r){if(!e.s){if(r instanceof R){if(!r.s)return void(r.o=k.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(k.bind(null,e,t),k.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var R=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{k(n,1,o(this.v))}catch(e){k(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?k(n,1,t?t(i):i):r?k(n,1,r(i)):k(n,2,i)}catch(e){k(n,2,e)}},n},e}();function V(e){return e instanceof R&&1&e.s}j=Symbol.toPrimitive;var _=/*#__PURE__*/function(){function e(e){if(this.address=void 0,this.address=e,!e.match(new RegExp("^[a-zA-Z0-9_-]{43}$")))throw new Error("Arweave addresses must be 43 characters in length with characters in the following set: [a-zA-Z0-9_-]")}var t=e.prototype;return t[j]=function(e){if("number"===e)throw new Error("Arweave addresses cannot be interpreted as a number!");return this.toString()},t.equals=function(e){return this.address===e.address},t.toString=function(){return this.address},t.valueOf=function(){return this.address},t.toJSON=function(){return this.toString()},e}();function J(e){return new _(e)}var K,G,B=/*#__PURE__*/function(){function t(e){var t=e.password,r=e.driveKeys,n=e.wallet;if(this.password=void 0,this.wallet=void 0,this.driveKeyCache={},this.unverifiedDriveKeys=void 0,t&&!n)throw new Error("Password supplied without a wallet. Did you forget to include your wallet?");if(t&&r)throw new Error("Password and drive keys can't be used together. Please provide one or the other.");this.unverifiedDriveKeys=null!=r?r:[],this.password=t,this.wallet=n}var r=t.prototype;return r.safelyDecryptToJson=function(t,r,n,i){try{var o,a=function(a){var s;if(o)return a;var c=function(){if(u.password&&u.wallet)return Promise.resolve(function(t,r,n){try{var i=Buffer.from(e.parse(r)),o=Buffer.from(v.default.encode("drive")),a=Buffer.concat([o,i]);return Promise.resolve(function(e,t){try{var r=f.createSign("sha256");r.update(t);var n=p.default(e,{private:!0}),i=r.sign({key:n,padding:f.constants.RSA_PKCS1_PSS_PADDING,saltLength:0});return Promise.resolve(i)}catch(e){return Promise.reject(e)}}(JSON.parse(n),a)).then(function(e){var r=v.default.encode(t),n=h.default(Buffer.from(e),32,{info:r,hash:"SHA-256"});return new H(n)})}catch(e){return Promise.reject(e)}}(u.password,""+r,JSON.stringify(u.wallet.getPrivateKey()))).then(function(e){return M(function(){return Promise.resolve(u.decryptToJson(t,n,e)).then(function(t){return u.driveKeyCache[""+r]=e,s=1,t})},function(){})})}();return c&&c.then?c.then(function(e){return s?e:i}):s?c:i},u=this,s=u.driveKeyForDriveId(r);if(s)return Promise.resolve(u.decryptToJson(t,n,s));var c=function(e,t,r){if("function"==typeof e[O]){var n,i,o,a=e[O]();if(function e(u){try{for(;!((n=a.next()).done||r&&r());)if((u=t(n.value))&&u.then){if(!V(u))return void u.then(e,o||(o=k.bind(null,i=new R,2)));u=u.v}i?k(i,1,u):i=u}catch(e){k(i||(i=new R),2,e)}}(),a.return){var u=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(u,function(e){throw u(e)});u()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var s=[],c=0;c<e.length;c++)s.push(e[c]);return function(e,t,r){var n,i,o=-1;return function a(u){try{for(;++o<e.length&&(!r||!r());)if((u=t(o))&&u.then){if(!V(u))return void u.then(a,i||(i=k.bind(null,n=new R,2)));u=u.v}n?k(n,1,u):n=u}catch(e){k(n||(n=new R),2,e)}}(),n}(s,function(e){return t(s[e])},r)}(u.unverifiedDriveKeys,function(e){return M(function(){return Promise.resolve(u.decryptToJson(t,n,e)).then(function(t){return u.driveKeyCache[""+r]=e,u.unverifiedDriveKeys=u.unverifiedDriveKeys.filter(function(t){return t!==e}),o=1,t})},function(){})},function(){return o});return Promise.resolve(c&&c.then?c.then(a):a(c))}catch(e){return Promise.reject(e)}},r.decryptToJson=function(e,t,r){try{return Promise.resolve(function(e,t,r){try{var n=r.slice(r.byteLength-De,r.byteLength),i=r.slice(0,r.byteLength-De),o=Buffer.from(e,"base64"),a=f.createDecipheriv("aes-256-gcm",t.keyData,o,{authTagLength:De});a.setAuthTag(n);var u=Buffer.concat([a.update(i),a.final()]);return Promise.resolve(u)}catch(e){return Promise.reject(e)}}(e,r,t)).then(function(e){return Promise.resolve(ee(e)).then(JSON.parse)})}catch(e){return Promise.reject(e)}},r.driveKeyForDriveId=function(e){var t;return null!=(t=this.driveKeyCache[""+e])&&t},t}(),U=/^[a-f\d]{8}-([a-f\d]{4}-){3}[a-f\d]{12}$/i;K=Symbol.toPrimitive;var z=/*#__PURE__*/function(){function e(e){if(this.entityId=void 0,this.entityId=e,!e.match(U)&&"ENCRYPTED"!==e)throw new Error("Invalid entity ID '"+e+"'!'")}var t=e.prototype;return t[K]=function(e){if("number"===e)throw new Error("Entity IDs cannot be interpreted as a number!");return this.toString()},t.toString=function(){return this.entityId},t.valueOf=function(){return this.entityId},t.equals=function(e){return this.entityId===e.entityId},t.toJSON=function(){return this.toString()},e}();function L(e){return new z(e)}G=Symbol.toPrimitive;var Q=/*#__PURE__*/function(){function e(e){if(this.unixTime=void 0,this.unixTime=e,this.unixTime<0||!Number.isInteger(this.unixTime)||!Number.isFinite(this.unixTime))throw new Error("Unix time must be a positive integer!")}var t=e.prototype;return t.equals=function(e){return+this.unixTime==+e.unixTime},t[G]=function(e){return"string"===e&&this.toString(),this.unixTime},t.toString=function(){return""+this.unixTime},t.valueOf=function(){return this.unixTime},t.toJSON=function(){return this.unixTime},e}(),H=/*#__PURE__*/function(){function e(e){if(this.keyData=void 0,this.keyData=e,!Buffer.isBuffer(e))throw new Error("The argument must be of type Buffer, got "+typeof e)}var t=e.prototype;return t.toString=function(){return this.keyData.toString("base64").replace("=","")},t.toJSON=function(){return this.toString()},e}(),W=function(e,t,r,n,i,o,a,u,s,c,d){this.appName=void 0,this.appVersion=void 0,this.arFS=void 0,this.contentType=void 0,this.driveId=void 0,this.entityType=void 0,this.name=void 0,this.txId=void 0,this.unixTime=void 0,this.customMetaDataGqlTags=void 0,this.customMetaDataJson=void 0,this.appName=e,this.appVersion=t,this.arFS=r,this.contentType=n,this.driveId=i,this.entityType=o,this.name=a,this.txId=u,this.unixTime=s,this.customMetaDataGqlTags=c,this.customMetaDataJson=d},$=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,f,h,v,p,y,m){var g;return(g=e.call(this,t,r,n,i,o,a,u,c,d,y,m)||this).entityType=void 0,g.size=void 0,g.lastModifiedDate=void 0,g.dataTxId=void 0,g.dataContentType=void 0,g.parentFolderId=void 0,g.entityId=void 0,g.entityType=a,g.size=s,g.lastModifiedDate=l,g.dataTxId=f,g.dataContentType=h,g.parentFolderId=v,g.entityId=p,g}return P(t,e),t}(W),Y=/*#__PURE__*/function(){function e(e){var t=e.entityId,r=e.gatewayApi,n=e.owner;this.appName=void 0,this.appVersion=void 0,this.arFS=void 0,this.contentType=void 0,this.driveId=void 0,this.entityType=void 0,this.name=void 0,this.txId=void 0,this.unixTime=void 0,this.entityId=void 0,this.gatewayApi=void 0,this.owner=void 0,this.customMetaData={},this.entityId=t,this.gatewayApi=r,this.owner=n}var t=e.prototype;return t.getDataForTxID=function(e){return this.gatewayApi.getTxData(e)},t.parseFromArweaveNode=function(e,t){try{var r=function(t){return n.txId=J(e.id),e.tags.forEach(function(e){var t=e.value;switch(e.name){case"App-Name":n.appName=t;break;case"App-Version":n.appVersion=t;break;case"ArFS":n.arFS=t;break;case"Content-Type":n.contentType=t;break;case"Drive-Id":n.driveId=L(t);break;case"Entity-Type":n.entityType=t;break;case"Unix-Time":n.unixTime=new Q(+t);break;default:i.push(e)}}),i},n=this,i=[],o=function(){if(!e){var r=te({tags:n.getGqlQueryParameters(),owner:t});return Promise.resolve(n.gatewayApi.gqlRequest(r)).then(function(t){var r=t.edges;if(!r.length)throw new Error("Entity with ID "+n.entityId+" not found!");e=r[0].node})}}();return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},t.build=function(e){try{var t=this;return Promise.resolve(t.parseFromArweaveNode(e,t.owner)).then(function(e){return t.parseCustomMetaDataFromGqlTags(e),t.buildEntity()})}catch(e){return Promise.reject(e)}},t.parseCustomMetaDataFromGqlTags=function(e){for(var t,r={},n=F(e);!(t=n()).done;){var i,o=t.value,a=o.name,u=o.value,s=r[a],c=s?Array.isArray(s)?[].concat(s,[u]):[s,u]:u;Object.assign(r,((i={})[a]=c,i))}!function(e){if("object"!=typeof e||null===e)return!1;for(var t=0,r=Object.entries(e);t<r.length;t++){var n=r[t],i=n[0],o=n[1];if(X.protectedArFSGqlTagNames.includes(i))return console.error("Provided custom metadata GQL tag name collides with a protected ArFS protected tag: "+i),!1;if("string"!=typeof o){if(!Array.isArray(o))return!1;for(var a,u=F(o);!(a=u()).done;){var s=a.value;if("string"!=typeof s)return!1;ne(s)}}else ne(o)}return!0}(r)?console.error("Parsed an invalid custom metadata shape from MetaData Tx GQL Tags: "+r):Object.keys(r).length>0&&(this.customMetaData.metaDataGqlTags=r)},t.parseCustomMetaDataFromDataJson=function(e){var t=this;if(function(e){try{JSON.parse(JSON.stringify(e))}catch(e){return!1}return!0}(e)){for(var r,n={},i=F(Object.entries(e).filter(function(e){return!t.protectedDataJsonKeys.includes(e[0])}));!(r=i()).done;){var o,a=r.value;Object.assign(n,((o={})[a[0]]=a[1],o))}Object.keys(n).length>0&&(this.customMetaData.metaDataJson=n)}else console.error("Parsed an invalid custom metadata shape from MetaData Tx Data JSON: "+e)},e}(),Z=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).parentFolderId=void 0,t}return P(t,e),t.prototype.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){return e.forEach(function(e){"Parent-Folder-Id"===e.name?r.parentFolderId=L(e.value):n.push(e)}),n})}catch(e){return Promise.reject(e)}},t}(Y),X=/*#__PURE__*/function(){function e(e){var t=e.appName,r=void 0===t?"default":t,n=e.appVersion,i=void 0===n?"default":n,o=e.arFSVersion,a=void 0===o?"default":o;this.appName=void 0,this.appVersion=void 0,this.arFSVersion=void 0,this.appName=r,this.appVersion=i,this.arFSVersion=a}return e.prototype.getFileDataItemTags=function(e,t){var r=this.baseAppTags;return r.push.apply(r,e?[we,Pe,be]:[{name:"Content-Type",value:t}]),r},I(e,[{key:"baseAppTags",get:function(){return[{name:"App-Name",value:this.appName},{name:"App-Version",value:this.appVersion}]}},{key:"baseArFSTags",get:function(){return[].concat(this.baseAppTags,[{name:"ArFS",value:this.arFSVersion}])}},{key:"baseBundleTags",get:function(){return[].concat(this.baseAppTags,[{name:"Bundle-Format",value:"binary"},{name:"Bundle-Version",value:"2.0.0"}])}}]),e}();X.protectedArFSGqlTagNames=q,w({},{created:[],tips:[],fees:{}},{manifest:{},links:[]});var ee=function(e){try{var t,r,n,i,o;t="";var a=e.length;for(r=0;r<a;)switch((n=e[r++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:i=e[r++],t+=String.fromCharCode((31&n)<<6|63&i);break;case 14:i=e[r++],o=e[r++],t+=String.fromCharCode((15&n)<<12|(63&i)<<6|(63&o)<<0)}return Promise.resolve(t)}catch(e){return Promise.reject(e)}};function te(e){var t=e.tags,r=e.cursor,n=e.owner,i=e.sort,o=void 0===i?"HEIGHT_DESC":i,a=e.ids,u="";(void 0===t?[]:t).forEach(function(e){u=u+'\n\t\t\t\t{ name: "'+e.name+'", values: '+(Array.isArray(e.value)?JSON.stringify(e.value):'"'+e.value+'"')+" }"});var s=void 0===r;return{query:"query {\n\t\t\ttransactions(\n\t\t\t\t"+(null!=a&&a.length?"ids: ["+a.map(function(e){return'"'+e+'"'})+"]":"")+"\n\t\t\t\tfirst: "+(s?1:100)+"\n\t\t\t\tsort: "+o+"\n\t\t\t\t"+(s?"":'after: "'+r+'"')+"\n\t\t\t\t"+(void 0===n?"":'owners: ["'+n+'"]')+"\n\t\t\t\ttags: [\n\t\t\t\t\t"+u+"\n\t\t\t\t]\n\t\t\t) {\n\t\t\t\t"+(s?"":"\n\tpageInfo {\n\t\thasNextPage\n\t}\n")+"\n\t\t\t\t"+N(s)+"\n\t\t\t}\n\t\t}"}}function re(e){var t,r,n=null!=(t=e.api.config.protocol)?t:Fe,i=null!=(r=e.api.config.host)?r:Te;return new URL(n+"://"+i+(e.api.config.port?":"+e.api.config.port:"")+"/")}function ne(e){if(0===e.length)throw Error("Metadata string must be at least one character!")}function ie(e,t,r){var n=r.filter(function(t){return t.entityId.equals(e.entityId)});return e.txId.equals(n[0].txId)}function oe(e,t,r){var n=r.filter(function(t){return t.driveId.equals(e.driveId)});return e.txId.equals(n[0].txId)}var ae=/*#__PURE__*/function(){function e(e,t){var r=this;this.dbPromise=void 0,this.cache=void 0,this._gatewayApi=void 0,this.dbPromise=this.initDatabase(e),this.dbPromise.then(function(e){r.cache=e}),this._gatewayApi=new A({gatewayUrl:re(null!=t?t:m.default.init({}))})}var t=e.prototype;return t.cacheKeyString=function(e){return"string"==typeof e?e:JSON.stringify(e)},t.initDatabase=function(e){try{return Promise.resolve(new Promise(function(e,t){var r=indexedDB.open("arfs-entity-cache-db",1);console.log("initializing database"),r.onerror=function(e){console.debug(e),t(r.error)},r.onupgradeneeded=function(e){var t=r.result.createObjectStore("cache",{keyPath:"key"});t.createIndex("key","key",{unique:!0}),t.createIndex("value","value")},r.onsuccess=function(t){console.debug(t),e(r.result)}}))}catch(e){return Promise.reject(e)}},t.put=function(e,t){try{var r=this,n=r.cacheKeyString(e);return Promise.resolve(r.dbPromise).then(function(e){return console.log("putting",n),console.log({cache:r.cache,cacheKey:n}),new Promise(function(r,i){var o=e.transaction("cache","readwrite").objectStore("cache").put({key:n.toString(),value:t});o.onsuccess=function(e){r(t)},o.onerror=function(e){i(o.error)}})})}catch(e){return Promise.reject(e)}},t.get=function(e){try{var t=this,r=t.cacheKeyString(e);return Promise.resolve(t.dbPromise).then(function(e){return console.log("getting",r),console.log({cache:t.cache,cacheKey:r}),new Promise(function(t,n){var i=e.transaction("cache","readonly").objectStore("cache").index("key").get(r);i.onsuccess=function(e){var r=i.result;t(r?r.value:void 0)},i.onerror=function(e){n(i.error)}})})}catch(e){return Promise.reject(e)}},t.remove=function(e){try{var t=this.cacheKeyString(e);return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(r,n){var i=e.transaction("cache","readwrite").objectStore("cache"),o=i.index("key").getKey(t);o.onsuccess=function(e){var t=o.result;if(void 0!==t){var a=i.delete(t);a.onsuccess=function(){r()},a.onerror=function(){console.debug(e),n(a.error)}}else r()},o.onerror=function(e){console.debug(e),n(o.error)}})})}catch(e){return Promise.reject(e)}},t.clear=function(){try{return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(t,r){var n=e.transaction("cache","readwrite").objectStore("cache").clear();n.onsuccess=function(e){console.debug(e),t()},n.onerror=function(e){console.debug(e),r(n.error)}})})}catch(e){return Promise.reject(e)}},t.size=function(){try{return Promise.resolve(this.dbPromise).then(function(e){return new Promise(function(t,r){var n=e.transaction("cache","readonly").objectStore("cache").count();n.onsuccess=function(e){console.debug(e),t(n.result)},n.onerror=function(e){console.debug(e),r(n.error)}})})}catch(e){return Promise.reject(e)}},e}(),ue=/*#__PURE__*/function(){function e(){}return e.platformCacheFolder=function(){return"metadata"},e.initDatabase=function(){try{return Promise.resolve(new Promise(function(e,t){var r=indexedDB.open("arfs-metadata-cache-db",1);console.log("Initializing database"),r.onerror=function(e){console.debug(e),t(r.error)},r.onupgradeneeded=function(e){var t=r.result.createObjectStore("cache",{keyPath:"txId"});t.createIndex("txId","txId",{unique:!0}),t.createIndex("buffer","buffer")},r.onsuccess=function(t){console.debug(t),e(r.result)}}))}catch(e){return Promise.reject(e)}},e.getCacheFolder=function(){try{var e=this;return e.cacheFolderPromise||(e.cacheFolderPromise=new Promise(function(t){t(e.metadataCacheFolder)})),Promise.resolve(e.cacheFolderPromise)}catch(e){return Promise.reject(e)}},e.put=function(e,t){try{var r=this;return Promise.resolve(r.getDatabase()).then(function(n){return console.log("putting",e),console.log({cache:r.metadataCacheFolder}),new Promise(function(r,i){var o=n.transaction("cache","readwrite").objectStore("cache").put({txId:e.toString(),buffer:t});o.onsuccess=function(e){console.debug(e),r()},o.onerror=function(e){console.debug(e),i(o.error)}})})}catch(e){return Promise.reject(e)}},e.get=function(e){try{var t=this;return Promise.resolve(t.getDatabase()).then(function(r){return new Promise(function(n,i){console.log("getting",e),console.log({cache:t.metadataCacheFolder});var o=r.transaction("cache","readonly").objectStore("cache").index("txId").get(e.toString());o.onsuccess=function(e){var t=o.result;t?(console.debug(e),n(t.buffer)):n(void 0)},o.onerror=function(e){console.debug(e),i(o.error)}})})}catch(e){return Promise.reject(e)}},e.getDatabase=function(){try{var e=this;return e.dbPromise||(e.dbPromise=e.initDatabase()),Promise.resolve(e.dbPromise)}catch(e){return Promise.reject(e)}},e}();ue.cacheFolderPromise=void 0,ue.shouldCacheLog="1"===process.env.ARDRIVE_CACHE_LOG,ue.metadataCacheFolder=ue.platformCacheFolder(),ue.logTag="[Metadata Cache] ",ue.dbPromise=void 0;var se={ownerCache:new ae(10),driveIdCache:new ae(10),publicDriveCache:new ae(10),publicFolderCache:new ae(10),publicFileCache:new ae(10)},ce=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,f,h,v,p,y){var m;return(m=e.call(this,t,r,n,i,o,"file",a,l,u,s,f,h,v,c,d,p,y)||this).fileId=void 0,m.fileId=d,m}return P(t,e),t}($),de=/*#__PURE__*/function(e){function t(t,r){var n;return(n=e.call(this,t.appName,t.appVersion,t.arFS,t.contentType,t.driveId,t.name,t.txId,t.unixTime,t.parentFolderId,t.fileId,t.size,t.lastModifiedDate,t.dataTxId,t.dataContentType,t.customMetaDataGqlTags,t.customMetaDataJson)||this).path=void 0,n.txIdPath=void 0,n.entityIdPath=void 0,n.path=""+r.pathToFolderId(t.parentFolderId)+t.name,n.txIdPath=""+r.txPathToFolderId(t.parentFolderId)+t.txId,n.entityIdPath=""+r.entityPathToFolderId(t.parentFolderId)+t.fileId,n}return P(t,e),t}(ce),le=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return P(t,e),t.fromArweaveNode=function(e,r){var n,i=null==(n=e.tags.find(function(e){return"File-Id"===e.name}))?void 0:n.value;if(!i)throw new Error("File-ID tag missing!");return new t({entityId:L(i),gatewayApi:r})},t.prototype.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid file state")},r=this,n=function(){var t,n,i,o,a;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.parentFolderId&&r.entityId)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(ee(t)).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){var n;if(r.name=t.name,r.size=new C(t.size),r.lastModifiedDate=new Q(t.lastModifiedDate),r.dataTxId=new _(t.dataTxId),r.dataContentType=null!=(n=t.dataContentType)?n:function(e){var t=e.substring(e.lastIndexOf(".")+1);t=t.toLowerCase();var r=y.lookup(t);return!1===r?"unknown":r}(r.name),!(r.name&&void 0!==r.size&&r.lastModifiedDate&&r.dataTxId&&r.dataContentType&&"file"===r.entityType))throw new Error("Invalid file state");r.parseCustomMetaDataFromDataJson(t);var i=Promise.resolve(new ce(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.name,r.txId,r.unixTime,r.parentFolderId,r.entityId,r.size,r.lastModifiedDate,r.dataTxId,r.dataContentType,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson));return e=1,i})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).size=void 0,t.lastModifiedDate=void 0,t.dataTxId=void 0,t.dataContentType=void 0,t.protectedDataJsonKeys=["name","size","lastModifiedDate","dataTxId","dataContentType"],t}P(t,e);var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"File-Id",value:""+this.entityId},{name:"Entity-Type",value:"file"}]},r.parseFromArweaveNode=function(t){try{return Promise.resolve(e.prototype.parseFromArweaveNode.call(this,t)).then(function(e){return e.filter(function(e){return"File-Id"!==e.name})})}catch(e){return Promise.reject(e)}},t}(Z));new C(2147483646);var fe=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,f){var h;return(h=e.call(this,t,r,n,i,o,"folder",a,new C(0),u,s,new Q(0),Ce,Ie,c,d,l,f)||this).folderId=void 0,h.folderId=d,h}return P(t,e),t}($),he=/*#__PURE__*/function(e){function t(t,r){var n;return(n=e.call(this,t.appName,t.appVersion,t.arFS,t.contentType,t.driveId,t.name,t.txId,t.unixTime,t.parentFolderId,t.folderId,t.customMetaDataGqlTags,t.customMetaDataJson)||this).path=void 0,n.txIdPath=void 0,n.entityIdPath=void 0,n.path=""+r.pathToFolderId(t.parentFolderId)+t.name,n.txIdPath=""+r.txPathToFolderId(t.parentFolderId)+t.txId,n.entityIdPath=""+r.entityPathToFolderId(t.parentFolderId)+t.folderId,n}return P(t,e),t}(fe),ve=/*#__PURE__*/function(){function e(e,t,r){void 0===r&&(r=[]),this.folderId=void 0,this.parent=void 0,this.children=void 0,this.folderId=e,this.parent=t,this.children=r}return e.fromEntity=function(t){return new e(t.entityId)},e}(),pe=/*#__PURE__*/function(){function e(e,t){this.folderIdToEntityMap=void 0,this.folderIdToNodeMap=void 0,this._rootNode=void 0,this.folderIdToEntityMap=e,this.folderIdToNodeMap=t}e.newFromEntities=function(t){for(var r,n=t.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.entityId]=t,r))},{}),i={},o=F(t);!(r=o()).done;)this.setupNodesWithEntity(r.value,n,i);return new e(n,i)},e.setupNodesWithEntity=function(e,t,r){var n=Object.keys(r).includes(""+e.entityId),i=Object.keys(r).includes(""+e.parentFolderId);if(!n){if(!i){var o=t[""+e.parentFolderId];o&&this.setupNodesWithEntity(o,t,r)}var a=r[""+e.parentFolderId];if(a){var u=new ve(e.entityId,a);a.children.push(u),r[""+e.entityId]=u}else{var s=new ve(e.entityId);r[""+e.entityId]=s}}};var t=e.prototype;return t.subTreeOf=function(t,r){var n=this;void 0===r&&(r=Number.MAX_SAFE_INTEGER);var i=this.nodeAndChildrenOf(this.folderIdToNodeMap[""+t],r);return new e(i.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.folderId]=n.folderIdToEntityMap[""+t.folderId],r))},{}),i.reduce(function(e,t){var r;return Object.assign(e,((r={})[""+t.folderId]=t,r))},{}))},t.allFolderIDs=function(){return Object.keys(this.folderIdToEntityMap).map(function(e){return L(e)})},t.nodeAndChildrenOf=function(e,t){var r=this,n=[e];return t>0&&e.children.forEach(function(e){n.push.apply(n,r.nodeAndChildrenOf(e,t-1))}),n},t.folderIdSubtreeFromFolderId=function(e,t){var r=this,n=this.folderIdToNodeMap[""+e],i=[n.folderId];return 0===t||n.children.map(function(e){return e.folderId}).forEach(function(e){i.push.apply(i,r.folderIdSubtreeFromFolderId(e,t-1))}),i},t.pathToFolderId=function(e){var t=this;if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===xe)return"/";for(var r=this.folderIdToNodeMap[""+e],n=[r];r.parent&&!r.folderId.equals(this.rootNode.folderId);)n.push(r=r.parent);return"/"+n.reverse().map(function(e){return t.folderIdToEntityMap[""+e.folderId].name}).join("/")+"/"},t.entityPathToFolderId=function(e){if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===xe)return"/";for(var t=this.folderIdToNodeMap[""+e],r=[t];t.parent&&!t.folderId.equals(this.rootNode.folderId);)r.push(t=t.parent);return"/"+r.reverse().map(function(e){return e.folderId}).join("/")+"/"},t.txPathToFolderId=function(e){var t=this;if(this.rootNode.parent)throw new Error("Can't compute paths from sub-tree");if(""+e===xe)return"/";for(var r=this.folderIdToNodeMap[""+e],n=[r];r.parent&&!r.folderId.equals(this.rootNode.folderId);)n.push(r=r.parent);return"/"+n.reverse().map(function(e){return t.folderIdToEntityMap[""+e.folderId].txId}).join("/")+"/"},I(e,[{key:"rootNode",get:function(){if(this._rootNode)return this._rootNode;for(var e=Object.keys(this.folderIdToEntityMap)[0],t=this.folderIdToNodeMap[e];t.parent&&this.folderIdToNodeMap[""+t.parent.folderId];)t=t.parent;return this._rootNode=t,t}}]),e}(),ye=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).protectedDataJsonKeys=["name"],t}P(t,e);var r=t.prototype;return r.parseFromArweaveNode=function(t){try{return Promise.resolve(e.prototype.parseFromArweaveNode.call(this,t)).then(function(e){return e.filter(function(e){return"Folder-Id"!==e.name})})}catch(e){return Promise.reject(e)}},r.getGqlQueryParameters=function(){return[{name:"Folder-Id",value:""+this.entityId},{name:"Entity-Type",value:"folder"}]},t}(Z),me=/*#__PURE__*/function(e){function t(){var t;return(t=e.call(this,""+Ne)||this).entityId=xe,t}return P(t,e),t}(z),ge=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return P(t,e),t.fromArweaveNode=function(e,r){var n,i=null==(n=e.tags.find(function(e){return"Folder-Id"===e.name}))?void 0:n.value;if(!i)throw new Error("Folder-ID tag missing!");return new t({entityId:L(i),gatewayApi:r})},t.prototype.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid public folder state")},r=this;r.parentFolderId||(r.parentFolderId=new me);var n=function(){var t,n,i,o,a;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.parentFolderId&&r.entityId&&"folder"===r.entityType)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(ee(t)).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){if(r.name=t.name,!r.name)throw new Error("Invalid public folder state: name not found!");r.parseCustomMetaDataFromDataJson(t);var n=Promise.resolve(new fe(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.name,r.txId,r.unixTime,r.parentFolderId,r.entityId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson));return e=1,n})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(ye),Ie="application/json",we={name:"Content-Type",value:"application/octet-stream"},Pe={name:"Cipher",value:"AES256-GCM"},be={name:"Cipher-IV",value:"qwertyuiopasdfgh"},Te="arweave.net",Fe="https",De=16,xe="root folder",Se="ENCRYPTED",Ee=500,Ae=["invalid_json","chunk_too_big","data_path_too_big","offset_too_big","data_size_too_big","chunk_proof_ratio_not_attractive","invalid_proof"],je={arFS:"ArFS",tipType:"Tip-Type",contentType:"Content-Type",boost:"Boost",bundleFormat:"Bundle-Format",bundleVersion:"Bundle-Version",entityType:"Entity-Type",unitTime:"Unix-Time",driveId:"Drive-Id",folderId:"Folder-Id",fileId:"File-Id",parentFolderId:"Parent-Folder-Id",drivePrivacy:"Drive-Privacy",cipher:"Cipher",cipherIv:"Cipher-IV",driveAuthMode:"Drive-Auth-Mode"},Ce=new _("0000000000000000000000000000000000000000000"),Ne=L("00000000-0000-0000-0000-000000000000"),qe=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,f,h){var v;return(v=e.call(this,t,r,n,i,o,a,u,s,c,f,h)||this).appName=void 0,v.appVersion=void 0,v.arFS=void 0,v.contentType=void 0,v.driveId=void 0,v.entityType=void 0,v.name=void 0,v.txId=void 0,v.unixTime=void 0,v.drivePrivacy=void 0,v.rootFolderId=void 0,v.appName=t,v.appVersion=r,v.arFS=n,v.contentType=i,v.driveId=o,v.entityType=a,v.name=u,v.txId=s,v.unixTime=c,v.drivePrivacy=d,v.rootFolderId=l,v}return P(t,e),t}(W),Me=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,f,h,v,p,y,m){var g;return(g=e.call(this,t,r,n,i,o,a,u,s,c,y,m)||this).appName=void 0,g.appVersion=void 0,g.arFS=void 0,g.contentType=void 0,g.driveId=void 0,g.entityType=void 0,g.name=void 0,g.txId=void 0,g.unixTime=void 0,g.drivePrivacy=void 0,g.rootFolderId=void 0,g.driveAuthMode=void 0,g.cipher=void 0,g.cipherIV=void 0,g.driveKey=void 0,g.appName=t,g.appVersion=r,g.arFS=n,g.contentType=i,g.driveId=o,g.entityType=a,g.name=u,g.txId=s,g.unixTime=c,g.drivePrivacy=d,g.rootFolderId=l,g.driveAuthMode=f,g.cipher=h,g.cipherIV=v,g.driveKey=p,g}return P(t,e),t}(W),Oe=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).protectedDataJsonKeys=["name","rootFolderId"],t}return P(t,e),t}(Y),ke=/*#__PURE__*/function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).drivePrivacy=void 0,t.rootFolderId=void 0,t}P(t,e),t.fromArweaveNode=function(e,r){var n,i=null==(n=e.tags.find(function(e){return"Drive-Id"===e.name}))?void 0:n.value;if(!i)throw new Error("Drive-ID tag missing!");return new t({entityId:L(i),gatewayApi:r})};var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"Drive-Id",value:""+this.entityId},{name:"Entity-Type",value:"drive"},{name:"Drive-Privacy",value:"public"}]},r.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){return e.forEach(function(e){"Drive-Privacy"===e.name?r.drivePrivacy=e.value:n.push(e)}),n})}catch(e){return Promise.reject(e)}},r.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid drive state")},r=this,n=function(){var t,n,i,o,a,u;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&r.driveId.equals(r.entityId)&&null!=(u=r.drivePrivacy)&&u.length)return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){return Promise.resolve(ee(t)).then(function(t){return Promise.resolve(JSON.parse(t)).then(function(t){if(r.name=t.name,r.rootFolderId=t.rootFolderId,!r.name||!r.rootFolderId)throw new Error("Invalid drive state");r.parseCustomMetaDataFromDataJson(t);var n=new qe(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,n})})})}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(Oe),Re=/*#__PURE__*/function(e){function t(t){var r,n=t.privateKeyData;return(r=e.call(this,{entityId:t.entityId,gatewayApi:t.gatewayApi})||this).drivePrivacy=void 0,r.rootFolderId=void 0,r.driveAuthMode=void 0,r.cipher=void 0,r.cipherIV=void 0,r.privateKeyData=void 0,r.privateKeyData=n,r}P(t,e);var r=t.prototype;return r.getGqlQueryParameters=function(){return[{name:"Drive-Id",value:""+this.entityId},{name:"Entity-Type",value:"drive"}]},t.fromArweaveNode=function(e,r,n){var i,o=null==(i=e.tags.find(function(e){return"Drive-Id"===e.name}))?void 0:i.value;if(!o)throw new Error("Drive-ID tag missing!");return new t({entityId:L(o),privateKeyData:n,gatewayApi:r})},r.parseFromArweaveNode=function(t){try{var r=this,n=[];return Promise.resolve(e.prototype.parseFromArweaveNode.call(r,t)).then(function(e){return e.forEach(function(e){var t=e.value;switch(e.name){case"Cipher":r.cipher=t;break;case"Cipher-IV":r.cipherIV=t;break;case"Drive-Auth-Mode":r.driveAuthMode=t;break;case"Drive-Privacy":r.drivePrivacy=t;break;default:n.push(e)}}),n})}catch(e){return Promise.reject(e)}},r.buildEntity=function(){try{var e,t=function(t){if(e)return t;throw new Error("Invalid drive state")},r=this,n=function(){var t,n,i,o,a,u;if(null!=(t=r.appName)&&t.length&&null!=(n=r.appVersion)&&n.length&&null!=(i=r.arFS)&&i.length&&null!=(o=r.contentType)&&o.length&&r.driveId&&null!=(a=r.entityType)&&a.length&&r.txId&&r.unixTime&&null!=(u=r.drivePrivacy)&&u.length){var s="private"===r.drivePrivacy;return Promise.resolve(r.getDataForTxID(r.txId)).then(function(t){var n=Buffer.from(t);return Promise.resolve(function(){try{if(s){var e,i,o;if(null!=(e=r.cipher)&&e.length&&null!=(i=r.driveAuthMode)&&i.length&&null!=(o=r.cipherIV)&&o.length)return Promise.resolve(r.privateKeyData.safelyDecryptToJson(r.cipherIV,r.entityId,n,{name:Se,rootFolderId:Se}));throw new Error("Invalid private drive state")}return Promise.resolve(ee(t)).then(JSON.parse)}catch(e){return Promise.reject(e)}}()).then(function(t){if(r.name=t.name,r.rootFolderId=L(t.rootFolderId),r.parseCustomMetaDataFromDataJson(t),s){if(!r.driveAuthMode||!r.cipher||!r.cipherIV)throw new Error("Unexpectedly null privacy data for private drive with ID "+r.driveId+"!");var n=new Ve(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.driveAuthMode,r.cipher,r.cipherIV,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,n}var i=new qe(r.appName,r.appVersion,r.arFS,r.contentType,r.driveId,r.entityType,r.name,r.txId,r.unixTime,r.drivePrivacy,r.rootFolderId,r.customMetaData.metaDataGqlTags,r.customMetaData.metaDataJson);return e=1,i})})}}();return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(e){return Promise.reject(e)}},t}(Oe),Ve=/*#__PURE__*/function(e){function t(t,r,n,i,o,a,u,s,c,d,l,f,h,v,p,y){var m;return(m=e.call(this,t,r,n,i,o,a,u,s,c,d,l,f,h,v,new H(Buffer.from([])),p,y)||this).driveKey=void 0,m.driveKey=new H(Buffer.from([])),delete m.driveKey,m}return P(t,e),t}(Me);function _e(e,t,r){if(!e.s){if(r instanceof Ke){if(!r.s)return void(r.o=_e.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(_e.bind(null,e,t),_e.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var Je=/*#__PURE__*/function(){function e(e,t,r){void 0===t&&(t=se),void 0===r&&(r=new A({gatewayUrl:re(e)})),this.caches=void 0,this.gatewayApi=void 0,this._arweave=void 0,this._gatewayApi=void 0,this._caches=void 0,this.appName=void 0,this.appVersion=void 0,this.caches=t,this.gatewayApi=r,this._arweave=e,this._gatewayApi=r,this._caches=t,this.appName="ArFS",this.appVersion="0.0.1"}var t=e.prototype;return t.getOwnerForDriveId=function(e){try{var t=this;return Promise.resolve(t.caches.ownerCache.get(e)).then(function(r){return r||t.caches.ownerCache.put(e,function(){try{var r=te({tags:[{name:"Drive-Id",value:""+e},{name:"Entity-Type",value:"drive"}],sort:"HEIGHT_ASC"});return Promise.resolve(t.gatewayApi.gqlRequest(r)).then(function(t){var r=t.edges;if(!r.length)throw new Error('Could not find a transaction with "Drive-Id": '+e);return J(r[0].node.owner.address)})}catch(e){return Promise.reject(e)}}())})}catch(e){return Promise.reject(e)}},t.getDriveIDForEntityId=function(e,t){try{var r=this;return Promise.resolve(r.caches.driveIdCache.get(e)).then(function(n){return n||r.caches.driveIdCache.put(e,function(){try{var n=te({tags:[{name:t,value:""+e}]});return Promise.resolve(r.gatewayApi.gqlRequest(n)).then(function(r){var n=r.edges;if(!n.length)throw new Error("Entity with "+t+" "+e+" not found!");var i=n[0].node.tags.find(function(e){return"Drive-Id"===e.name});if(i)return L(i.value);throw new Error("No Drive-Id tag found for meta data transaction of "+t+": "+e)})}catch(e){return Promise.reject(e)}}())})}catch(e){return Promise.reject(e)}},t.getDriveOwnerForFolderId=function(e){try{var t=this,r=t.getOwnerForDriveId;return Promise.resolve(t.getDriveIdForFolderId(e)).then(function(e){return r.call(t,e)})}catch(e){return Promise.reject(e)}},t.getDriveIdForFolderId=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"Folder-Id"))}catch(e){return Promise.reject(e)}},t.getDriveOwnerForFileId=function(e){try{var t=this,r=t.getOwnerForDriveId;return Promise.resolve(t.getDriveIdForFileId(e)).then(function(e){return r.call(t,e)})}catch(e){return Promise.reject(e)}},t.getDriveIdForFileId=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"File-Id"))}catch(e){return Promise.reject(e)}},t.getDriveIdForEntityID=function(e){try{return Promise.resolve(this.getDriveIDForEntityId(e,"Folder-Id"))}catch(e){return Promise.reject(e)}},t.getPublicDrive=function(e){var t=e.driveId,r=e.owner;try{var n=this,i={driveId:t,owner:r};return Promise.resolve(n.caches.publicDriveCache.get(i)).then(function(e){return e||Promise.resolve(n.caches.publicDriveCache.put(i,new ke({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()))})}catch(e){return Promise.reject(e)}},t.getPublicFolder=function(e){var t=e.folderId,r=e.owner;try{var n=this,i={folderId:t,owner:r};return Promise.resolve(n.caches.publicFolderCache.get(i)).then(function(e){return e||Promise.resolve(n.caches.publicFolderCache.put(i,new ge({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()))})}catch(e){return Promise.reject(e)}},t.getPublicFile=function(e){var t=e.fileId,r=e.owner;try{var n=this,i={fileId:t,owner:r};return Promise.resolve(n.caches.publicFileCache.get(i)).then(function(e){return e||Promise.resolve(n.caches.publicFileCache.put(i,new le({entityId:t,gatewayApi:n.gatewayApi,owner:r}).build()))})}catch(e){return Promise.reject(e)}},t.getAllDrivesForAddress=function(e){var t=e.address,r=e.privateKeyData,n=e.latestRevisionsOnly,i=void 0===n||n;try{var o=function(){return i?d.filter(oe):d},a=this,u=new _(t),s="",c=!0,d=[],l=Be(function(){return!!c},void 0,function(){var e=te({tags:[{name:"Entity-Type",value:"drive"}],cursor:s,owner:u});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){c=e.pageInfo.hasNextPage;var t=e.edges.map(function(e){try{var t=e.node;s=e.cursor;var n=Re.fromArweaveNode(t,a.gatewayApi,r);return Promise.resolve(n.build(t)).then(function(e){return"public"===e.drivePrivacy?a.caches.publicDriveCache.put({driveId:e.driveId,owner:u},Promise.resolve(e)):Promise.resolve(e)})}catch(e){return Promise.reject(e)}}),n=d.push;return Promise.resolve(Promise.all(t)).then(function(e){n.call.apply(n,[d].concat(e))})})});return Promise.resolve(l&&l.then?l.then(o):o())}catch(e){return Promise.reject(e)}},t.getPublicFilesWithParentFolderIds=function(e,t,r){void 0===r&&(r=!1);try{var n=function(){return r?u.filter(ie):u},i=this,o="",a=!0,u=[],s=Be(function(){return!!a},void 0,function(){var r=te({tags:[{name:"Parent-Folder-Id",value:e.map(function(e){return e.toString()})},{name:"Entity-Type",value:"file"}],cursor:o,owner:t});return Promise.resolve(i.gatewayApi.gqlRequest(r)).then(function(e){a=e.pageInfo.hasNextPage;var r=e.edges.map(function(e){try{var r=e.node;o=e.cursor;var n=le.fromArweaveNode(r,i.gatewayApi);return Promise.resolve(n.build(r)).then(function(e){var r={fileId:e.fileId,owner:t};return u.push(e),i.caches.publicFileCache.put(r,Promise.resolve(e))})}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(r)).then(function(){})})});return Promise.resolve(s&&s.then?s.then(n):n())}catch(e){return Promise.reject(e)}},t.getAllFoldersOfPublicDrive=function(e){var t=e.driveId,r=e.owner,n=e.latestRevisionsOnly,i=void 0!==n&&n;try{var o=function(){return i?c.filter(ie):c},a=this,u="",s=!0,c=[],d=Be(function(){return!!s},void 0,function(){var e=te({tags:[{name:"Drive-Id",value:""+t},{name:"Entity-Type",value:"folder"}],cursor:u,owner:r});return Promise.resolve(a.gatewayApi.gqlRequest(e)).then(function(e){s=e.pageInfo.hasNextPage;var t=e.edges.map(function(e){try{var t=e.node;u=e.cursor;var n=ge.fromArweaveNode(t,a.gatewayApi);return Promise.resolve(n.build(t)).then(function(e){return a.caches.publicFolderCache.put({folderId:e.entityId,owner:r},Promise.resolve(e))})}catch(e){return Promise.reject(e)}}),n=c.push;return Promise.resolve(Promise.all(t)).then(function(e){n.call.apply(n,[c].concat(e))})})});return Promise.resolve(d&&d.then?d.then(o):o())}catch(e){return Promise.reject(e)}},t.listPublicFolder=function(e){var t=e.folderId,r=e.maxDepth,n=e.includeRoot,i=e.owner;try{var o=this;if(!Number.isInteger(r)||r<0)throw new Error("maxDepth should be a non-negative integer!");return Promise.resolve(o.getPublicFolder({folderId:t,owner:i})).then(function(e){return Promise.resolve(o.getAllFoldersOfPublicDrive({driveId:e.driveId,owner:i,latestRevisionsOnly:!0})).then(function(a){function u(){for(var e,t=[],r=F(l);!(e=r()).done;)t.push(e.value);for(var n,i=F(f);!(n=i()).done;)t.push(n.value);var o=t.map(function(e){return function(e,t){return"folder"===e.entityType?new he(e,t):new de(e,t)}(e,s)});return o}var s=pe.newFromEntities(a),c=s.folderIdSubtreeFromFolderId(t,r),d=s.folderIdSubtreeFromFolderId(t,r+1).slice(1),l=a.filter(function(e){return d.some(function(t){return t.equals(e.entityId)})});n&&l.unshift(e);var f=[],h=function(e,t,r){if("function"==typeof e[Ue]){var n,i,o,a=e[Ue]();if(function e(r){try{for(;!(n=a.next()).done;)if((r=t(n.value))&&r.then){if(!Ge(r))return void r.then(e,o||(o=_e.bind(null,i=new Ke,2)));r=r.v}i?_e(i,1,r):i=r}catch(e){_e(i||(i=new Ke),2,e)}}(),a.return){var u=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(u,function(e){throw u(e)});u()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var s=[],c=0;c<e.length;c++)s.push(e[c]);return function(e,t,r){var n,i,o=-1;return function r(a){try{for(;++o<e.length;)if((a=t(o))&&a.then){if(!Ge(a))return void a.then(r,i||(i=_e.bind(null,n=new Ke,2)));a=a.v}n?_e(n,1,a):n=a}catch(e){_e(n||(n=new Ke),2,e)}}(),n}(s,function(e){return t(s[e])})}(c,function(e){return Promise.resolve(o.getPublicFilesWithParentFolderIds([e],i,!0)).then(function(e){e.forEach(function(e){f.push(e)})})});return h&&h.then?h.then(u):u()})})}catch(e){return Promise.reject(e)}},e}();const Ke=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,i=this.s;if(i){const e=1&i?t:r;if(e){try{_e(n,1,e(this.v))}catch(e){_e(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?_e(n,1,t?t(i):i):r?_e(n,1,r(i)):_e(n,2,i)}catch(e){_e(n,2,e)}},n},e}();function Ge(e){return e instanceof Ke&&1&e.s}function Be(e,t,r){for(var n;;){var i=e();if(Ge(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!Ge(o)){n=1;break}o=o.s}if(t){var a=t();if(a&&a.then&&!Ge(a)){n=2;break}}}var u=new Ke,s=_e.bind(null,u,2);return(0===n?i.then(d):1===n?o.then(c):a.then(l)).then(void 0,s),u;function c(n){o=n;do{if(t&&(a=t())&&a.then&&!Ge(a))return void a.then(l).then(void 0,s);if(!(i=e())||Ge(i)&&!i.v)return void _e(u,1,o);if(i.then)return void i.then(d).then(void 0,s);Ge(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,s)}function d(e){e?(o=r())&&o.then?o.then(c).then(void 0,s):c(o):_e(u,1,o)}function l(){(i=e())?i.then?i.then(d).then(void 0,s):d(i):_e(u,1,o)}}var Ue="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";exports.ArFSClient=Je,exports.ArweaveAddress=_,exports.PrivateKeyData=B;
